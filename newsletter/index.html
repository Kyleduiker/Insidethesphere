<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newsletter Builder Pro - Inside the Sphere</title>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Your Firebase Config -->
    <script src="../js/firebase-config.js"></script>
    
    <!-- Navigation Styles and Scripts -->
    <link rel="stylesheet" href="../assets/css/navigation.css">
    <script src="../assets/js/navigation.js"></script>
    
    <!-- NAVIGATION CONFIGURATION -->
    <script>
    // Configure navigation for newsletter builder page
    configureSphereNav({ 
        requireAuth: false, // Newsletter builder doesn't require auth
        loginRedirectUrl: '/',
        homeUrl: '/'
    });
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;500;600&family=Crimson+Text:wght@400;600&family=Raleway:wght@300;400;500&family=Lora:wght@400;500&family=Cormorant+Garamond:wght@300;400;500&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #f39c12;
            --primary-dark: #e67e22;
            --secondary-color: #27ae60;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --border-color: #e0e0e0;
            --background-dark: #2c3e50;
            --background-light: #f8f9fa;
            --background-card: #ffffff;
            --text-light: #2c3e50;
            --text-muted: #666666;
            --text-secondary: #999999;
            --text-dark: #2c3e50;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(243, 156, 18, 0.1);
            --transition: all 0.3s ease;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--background-light);
            color: var(--text-light);
            min-height: 100vh;
            line-height: 1.5;
            padding-top: 80px;
        }

        .main-content {
            padding: 40px 20px;
            background: var(--background-light);
            min-height: 100vh;
        }

        .content-container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 500px 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .sidebar {
            background: var(--background-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow-y: auto;
            max-height: 90vh;
            position: sticky;
            top: 100px;
            box-shadow: var(--box-shadow);
        }

        .preview-container {
            background: var(--background-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            overflow-y: auto;
            max-height: 90vh;
            position: sticky;
            top: 100px;
            box-shadow: var(--box-shadow);
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 30px 25px;
            text-align: center;
        }

        .app-header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 26px;
            font-weight: 400;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .app-header .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .app-header .edition-badge {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 5px;
            font-size: 12px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .form-content {
            padding: 30px 25px;
        }

        .form-section {
            margin-bottom: 35px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 25px;
            background: var(--background-card);
        }

        .form-section__header {
            color: var(--primary-color);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-section__header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group__label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-muted);
            font-size: 13px;
        }

        .form-group__input,
        .form-group__textarea,
        .form-group__select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            font-family: 'Montserrat', sans-serif;
            transition: var(--transition);
            background: white;
            color: #333333;
            min-height: 44px;
        }

        .form-group__select {
            background: var(--background-card);
            color: var(--text-light);
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23f39c12' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        .form-group__select option {
            background: var(--background-card);
            color: var(--text-light);
            padding: 8px;
        }

        .form-group__input:focus,
        .form-group__textarea:focus,
        .form-group__select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.1);
            transform: translateY(-1px);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: var(--background-card);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 12px 15px;
            transition: var(--transition);
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 44px;
        }

        .stat-item:focus-within {
            border-color: var(--primary-color);
        }

        .stat-item__label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 600;
            letter-spacing: 0.5px;
            margin: 0;
            flex: 1;
        }

        .stat-item__input {
            border: none;
            padding: 0;
            font-size: 15px;
            font-weight: 600;
            color: var(--primary-color);
            background: transparent;
            text-align: right;
            width: 100px;
            flex-shrink: 0;
        }

        .stat-item__input:focus {
            outline: 1px solid var(--primary-color);
            border-radius: 4px;
            padding: 4px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 13px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-height: 44px;
            justify-content: center;
            text-decoration: none;
        }

        .btn:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .btn--primary {
            background: var(--primary-color);
            color: white;
        }

        .btn--primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
        }

        .btn--secondary {
            background: #666666;
            color: white;
        }

        .btn--success {
            background: var(--success-color);
            color: white;
        }

        .btn--info {
            background: var(--info-color);
            color: white;
        }

        .btn--full {
            width: 100%;
            justify-content: center;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay--show {
            display: flex;
        }

        .modal {
            background: var(--background-card);
            border: 1px solid var(--border-color);
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .toast-container {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            min-width: 300px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            box-shadow: var(--box-shadow);
            animation: slideIn 0.3s ease-out;
            position: relative;
            overflow: hidden;
        }

        .toast--success { background: var(--success-color); }
        .toast--error { background: var(--danger-color); }
        .toast--warning { background: var(--warning-color); }
        .toast--info { background: var(--info-color); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .preview-header {
            background: var(--background-light);
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .preview-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .newsletter-preview {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            max-width: 700px;
            margin: 0 auto 20px auto;
            color: var(--text-dark);
        }

        .event-item {
            background: var(--background-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .event-delete {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            min-height: 44px;
        }

        .image-preview {
            display: flex;
            align-items: center;
            padding: 10px;
            background: var(--background-light);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .required-field::after {
            content: ' *';
            color: var(--danger-color);
            font-weight: bold;
        }

        .validation-message {
            font-size: 12px;
            margin-top: 5px;
            display: none;
            line-height: 1.4;
        }

        .validation-message.error {
            color: var(--danger-color);
            display: block;
        }

        .validation-message.success {
            color: var(--success-color);
            display: block;
        }

        .compatibility-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ff9800;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            color: #856404;
        }

        .compatibility-warning h4 {
            color: #856404;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .compatibility-warning ul {
            color: #856404;
            margin: 0;
            padding-left: 20px;
        }

        .compatibility-info {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #0c5460;
        }

        @media (max-width: 1023px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .sidebar {
                height: auto;
                max-height: none;
                position: static;
            }
            
            .preview-container {
                position: static;
                max-height: none;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        @media (max-width: 767px) {
            body {
                padding-top: 70px;
            }
            
            .main-content {
                padding: 30px 10px;
            }
            
            .form-content {
                padding: 20px 15px;
            }
            
            .form-section {
                padding: 15px;
                margin-bottom: 20px;
            }
            
            .preview-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .preview-actions .btn {
                width: 100%;
            }
            
            .toast-container {
                top: 80px;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeInUp 0.8s ease;
        }

        .form-group__input[type="file"] {
            padding: 8px 15px;
            cursor: pointer;
        }

        .form-group__input[type="file"]::-webkit-file-upload-button {
            background: var(--primary-color);
            color: #000;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            margin-right: 10px;
            font-size: 12px;
            cursor: pointer;
        }

        .form-group__input[type="color"] {
            height: 44px !important;
            width: 60px !important;
            padding: 2px !important;
            cursor: pointer !important;
            border: 2px solid var(--border-color) !important;
            border-radius: var(--border-radius) !important;
            background: white !important;
        }

        .form-group__input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 2px !important;
            border-radius: 6px !important;
        }

        .form-group__input[type="color"]::-webkit-color-swatch {
            border: none !important;
            border-radius: 4px !important;
        }

        .form-group__input[type="color"]::-moz-color-swatch {
            border: none !important;
            border-radius: 4px !important;
        }

        .stats-section-header {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .quick-color-btn {
            width: 30px;
            height: 30px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
        }

        .quick-color-btn:hover {
            transform: scale(1.1);
            border-color: var(--primary-color);
        }

        input.form-group__input,
        textarea.form-group__textarea,
        select.form-group__select,
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="url"],
        textarea {
            background: white !important;
            background-color: white !important;
            color: #333333 !important;
        }

        input[id*="Hex"],
        input[id$="ColorHex"] {
            background: white !important;
            background-color: white !important;
            color: #333333 !important;
        }

        #customSubtitle {
            background: white !important;
            background-color: white !important;
            color: #333333 !important;
        }

        small {
            color: var(--text-secondary);
            font-size: 11px;
        }

        .emoji-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 18px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-btn:hover {
            background: var(--background-light);
            border-color: var(--primary-color);
            transform: scale(1.1);
        }

        .emoji-btn:active {
            transform: scale(0.95);
        }

        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            body {
                margin: 0;
                padding: 0;
                background: white !important;
                font-size: 12pt;
                line-height: 1.4;
            }
            
            .sidebar,
            .preview-header,
            .preview-actions,
            .toast-container,
            .modal-overlay {
                display: none !important;
            }
            
            .newsletter-preview {
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
                max-width: none !important;
                width: 100% !important;
                background: white !important;
            }
            
            .preview-container {
                position: static !important;
                max-height: none !important;
                overflow: visible !important;
                padding: 0 !important;
                margin: 0 !important;
                border: none !important;
                box-shadow: none !important;
                background: white !important;
            }
            
            .dashboard-container {
                display: block !important;
            }
            
            h1, h2, h3 {
                page-break-after: avoid;
            }
            
            img {
                max-width: 100% !important;
                height: auto !important;
                page-break-inside: avoid;
            }
            
            .newsletter-preview > div {
                page-break-inside: avoid;
            }
            
            @page {
                size: letter;
                margin: 0.5in;
            }
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>

    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <h3 style="margin-bottom: 20px; font-size: 20px; color: var(--primary-color);">📧 Export Newsletter</h3>
            
            <div class="compatibility-warning">
                <h4>✅ Email Client Compatibility</h4>
                <ul style="margin: 10px 0; font-size: 13px; line-height: 1.4;">
                    <li>All images are automatically uploaded to Imgur for perfect email compatibility</li>
                    <li>Newsletter uses hosted image URLs - works in all email clients</li>
                    <li>No blocked images or deliverability issues</li>
                    <li>Always test in your target email clients before sending</li>
                    <li>Professional hosting ensures images load reliably</li>
                </ul>
            </div>
            
            <div class="compatibility-info">
                <h4>📊 Email Client Support</h4>
                <div>
                    ✅ <strong>Gmail:</strong> Excellent support<br>
                    ✅ <strong>Apple Mail:</strong> Best support
                </div>
            </div>

            <div class="compatibility-info">
                <h4>🖨️ Print Optimization</h4>
                <div>
                    <strong>Print Version:</strong> Optimized for standard letter paper (8.5" x 11")<br>
                    <strong>Features:</strong> Proper margins, page breaks, black & white friendly<br>
                    <strong>Best For:</strong> Client handouts, office distribution, archival copies
                </div>
            </div>
            
            <div style="display: grid; gap: 10px; margin-top: 20px;">
                <button class="btn btn--primary" onclick="exportManager.copyEmailSafeHTML()">
                    📧 Copy Newsletter for email
                </button>
                <button class="btn btn--success" onclick="exportManager.exportAsHTML()">
                    📄 Download HTML File (Hosted URLs)
                </button>
                <button class="btn btn--info" onclick="exportManager.printNewsletter()">
                    🖨️ Print Newsletter
                </button>
                <button class="btn btn--secondary" onclick="modalManager.close('exportModal')">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="addEventModal">
        <div class="modal">
            <h3 style="margin-bottom: 20px; color: var(--primary-color);">Add Event</h3>
            <form id="addEventForm">
                <div class="form-group">
                    <label class="form-group__label required-field">Event Title</label>
                    <input type="text" class="form-group__input" id="eventTitle" required>
                    <div class="validation-message" id="eventTitle-validation"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-group__label required-field">Date</label>
                        <input type="date" class="form-group__input" id="eventDate" required>
                        <div class="validation-message" id="eventDate-validation"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-group__label">Start Time</label>
                        <input type="time" class="form-group__input" id="eventStartTime">
                        <div class="validation-message" id="eventStartTime-validation"></div>
                        <small>Optional - leave blank for all-day events</small>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-group__label">End Time</label>
                    <input type="time" class="form-group__input" id="eventEndTime">
                    <div class="validation-message" id="eventEndTime-validation"></div>
                    <small>Optional - leave blank if no specific end time</small>
                </div>
                <div class="form-group">
                    <label class="form-group__label">Location</label>
                    <input type="text" class="form-group__input" id="eventLocation">
                    <div class="validation-message" id="eventLocation-validation"></div>
                    <small>Optional - leave blank for online events or TBA</small>
                </div>
                <div class="form-group">
                    <label class="form-group__label">Description (Optional)</label>
                    <textarea class="form-group__textarea" id="eventDescription" rows="3"></textarea>
                    <div class="validation-message" id="eventDescription-validation"></div>
                </div>
                <div class="form-group">
                    <label class="form-group__label">Event Details Link (Optional)</label>
                    <input type="url" class="form-group__input" id="eventDetailsLink" placeholder="https://example.com/event-details">
                    <div class="validation-message" id="eventDetailsLink-validation"></div>
                    <small>Optional - link to registration page, more details, or event website</small>
                </div>
                <div class="form-group">
                    <label class="form-group__label">Event Image (Optional)</label>
                    <input type="file" class="form-group__input" id="eventImage" accept="image/*" onchange="handleEventImageUpload()">
                    <div class="image-preview" id="eventImagePreview" style="margin-top: 10px; display: none;">
                        <img style="width: 120px; height: 80px; object-fit: cover; border-radius: 4px; border: 2px solid #ddd;">
                        <button type="button" onclick="removeEventImage()" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Remove</button>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn--primary" style="flex: 1;">Add Event</button>
                    <button type="button" class="btn btn--secondary" onclick="modalManager.close('addEventModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="addCustomPropertyTypeModal">
        <div class="modal">
            <h3 style="margin-bottom: 20px; color: var(--primary-color);">Add Custom Property Type</h3>
            <form id="addCustomPropertyTypeForm">
                <div class="form-group">
                    <label class="form-group__label required-field">Property Type Name</label>
                    <input type="text" class="form-group__input" id="customPropertyTypeName" required placeholder="e.g., Luxury Condos, Mobile Homes, etc.">
                    <div class="validation-message" id="customPropertyTypeName-validation"></div>
                </div>
                <div class="form-group">
                    <label class="form-group__label">Property Type Icon</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-group__input" id="customPropertyTypeIcon" placeholder="🏘️" maxlength="2" style="flex: 1;">
                        <button type="button" class="btn btn--info" onclick="toggleCustomPropertyEmojiPicker()" style="padding: 12px 16px;" title="Pick Emoji">
                            😊
                        </button>
                    </div>
                    <div class="validation-message" id="customPropertyTypeIcon-validation"></div>
                    <small>Optional - single emoji to represent this property type</small>
                    
                    <div id="customPropertyEmojiPicker" style="display: none; margin-top: 10px; padding: 15px; background: var(--background-card); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: var(--box-shadow);">
                        <div style="margin-bottom: 10px;">
                            <strong style="color: var(--primary-color); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">🏠 Houses & Buildings</strong>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;">
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏠')">🏠</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏡')">🏡</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏘️')">🏘️</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏢')">🏢</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏬')">🏬</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏭')">🏭</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏗️')">🏗️</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏚️')">🏚️</button>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <strong style="color: var(--primary-color); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">🏰 Special Properties</strong>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;">
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏰')">🏰</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏯')">🏯</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🗼')">🗼</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🕌')">🕌</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('⛪')">⛪</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏛️')">🏛️</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏟️')">🏟️</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🎪')">🎪</button>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <strong style="color: var(--primary-color); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">🏕️ Outdoor & Recreation</strong>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;">
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏕️')">🏕️</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('⛺')">⛺</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏞️')">🏞️</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏖️')">🏖️</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏝️')">🏝️</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('⛰️')">⛰️</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏔️')">🏔️</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🗻')">🗻</button>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <strong style="color: var(--primary-color); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">🚗 Transportation & Access</strong>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;">
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🚗')">🚗</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🚙')">🚙</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏎️')">🏎️</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🚐')">🚐</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🚛')">🚛</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🚌')">🚌</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🚂')">🚂</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('✈️')">✈️</button>
                            </div>
                        </div>
                        
                        <div>
                            <strong style="color: var(--primary-color); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">💎 Luxury & Premium</strong>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;">
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('💎')">💎</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('👑')">👑</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🌟')">🌟</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('⭐')">⭐</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('✨')">✨</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🔥')">🔥</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('💰')">💰</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏆')">🏆</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn--primary" style="flex: 1;">Add Property Type</button>
                    <button type="button" class="btn btn--secondary" onclick="modalManager.close('addCustomPropertyTypeModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="maintenanceTipsModal">
        <div class="modal">
            <h3 style="margin-bottom: 20px; color: var(--primary-color);">🔧 Manage Maintenance Tips</h3>
            
            <div style="margin-bottom: 20px; padding: 15px; background: var(--background-light); border: 1px solid var(--border-color); border-radius: 6px;">
                <strong style="color: var(--primary-color);">Current Month: </strong>
                <span id="modalCurrentMonth" style="text-transform: capitalize;"></span>
            </div>
            
            <div id="modalMaintenanceTipsList" style="margin-bottom: 20px; max-height: 300px; overflow-y: auto;">
            </div>
            
            <div class="form-group">
                <label class="form-group__label">Add New Tip</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" class="form-group__input" id="modalNewMaintenanceTip" placeholder="Enter a new maintenance tip..." style="flex: 1;">
                    <button type="button" class="btn btn--info" onclick="toggleModalEmojiPicker()" style="padding: 12px 16px;" title="Add Emoji">
                        😊
                    </button>
                    <button type="button" class="btn btn--primary" onclick="addModalMaintenanceTip()" style="padding: 12px 20px;">
                        Add Tip
                    </button>
                </div>
                
                <div id="modalEmojiPicker" style="display: none; margin-top: 10px; padding: 15px; background: var(--background-card); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: var(--box-shadow);">
                    <div style="margin-bottom: 10px;">
                        <strong style="color: var(--primary-color); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">🔧 Tools & Maintenance</strong>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;">
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🔧')">🔧</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🔨')">🔨</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🪚')">🪚</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('⚒️')">⚒️</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🧰')">🧰</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('⚙️')">⚙️</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🔩')">🔩</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('⚡')">⚡</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <strong style="color: var(--primary-color); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">🏠 Home & Garden</strong>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;">
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🏠')">🏠</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🏡')">🏡</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🪟')">🪟</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🚪')">🚪</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🌿')">🌿</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🌱')">🌱</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🌳')">🌳</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🌺')">🌺</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <strong style="color: var(--primary-color); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">🌦️ Weather & Seasons</strong>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;">
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('❄️')">❄️</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🌨️')">🌨️</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('☀️')">☀️</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🌧️')">🌧️</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('💨')">💨</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🍂')">🍂</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🌡️')">🌡️</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🧊')">🧊</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <strong style="color: var(--primary-color); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">💧 Utilities & Safety</strong>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;">
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('💧')">💧</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🚿')">🚿</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🔥')">🔥</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('💡')">💡</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🚨')">🚨</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🧹')">🧹</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🧽')">🧽</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🧴')">🧴</button>
                        </div>
                    </div>
                    
                    <div>
                        <strong style="color: var(--primary-color); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">📋 Tasks & Reminders</strong>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;">
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('📋')">📋</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('✅')">✅</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('📝')">📝</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('📅')">📅</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('⏰')">⏰</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🔔')">🔔</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('⚠️')">⚠️</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🎯')">🎯</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: var(--background-light); border: 1px solid var(--border-color); border-radius: 6px;">
                <button type="button" class="btn btn--secondary btn--full" onclick="resetToDefaultTips()" style="margin-bottom: 10px;">
                    🔄 Reset to Default Seasonal Tips
                </button>
                <small style="display: block; text-align: center; color: var(--text-muted);">This will restore the original tips for the selected month and remove all custom tips</small>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn--primary" onclick="modalManager.close('maintenanceTipsModal')" style="flex: 1;">Done</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="rlpInstructionsModal">
        <div class="modal">
            <h3 style="margin-bottom: 20px; color: #EA002A; display: flex; align-items: center; gap: 10px;">
                <img src="https://i.imgur.com/5q2V1qG.png" style="height: 24px; width: auto; object-fit: contain;" alt="Royal LePage Logo">
                Royal LePage Sphere Integration
            </h3>
            
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border: 1px solid #EA002A; border-radius: 6px;">
                <h4 style="color: #EA002A; margin-bottom: 10px; font-size: 16px;">📧 How to Add Your Newsletter to RLP Sphere</h4>
                <p style="margin-bottom: 15px; color: #4D4D4D; line-height: 1.5;">Follow these simple steps to paste your newsletter into Royal LePage Sphere:</p>
                
                <ol style="color: #4D4D4D; line-height: 1.6; padding-left: 20px;">
                    <li style="margin-bottom: 10px;"><strong>Generate your newsletter:</strong> Click "Generate Newsletter" and then "Export Options" → "Copy Newsletter for email"</li>
                    <li style="margin-bottom: 10px;"><strong>Login to RLPnetwork.com:</strong> Go to your Royal LePage Sphere dashboard</li>
                    <li style="margin-bottom: 10px;"><strong>Create New Email:</strong> Navigate to Marketing → Smart Campaigns → Templates → Add email </li>
                    <li style="margin-bottom: 10px;"><strong>Select HTML editor:</strong> Choose the HTML/Code editor option</li>
                    <li style="margin-bottom: 10px;"><strong>Paste your newsletter:</strong> Paste the copied HTML code into the editor</li>
                    <li style="margin-bottom: 10px;"><strong>Preview & test:</strong> Use Sphere's preview function to check your newsletter</li>
                    <li><strong>Send or schedule:</strong> Add your contacts and send or schedule your newsletter</li>
                </ol>
            </div>
            
            <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 15px; margin-bottom: 20px;">
                <h5 style="color: #856404; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                    ⚠️ Important Notes
                </h5>
                <ul style="color: #856404; margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.4;">
                    <li>Always use "Copy Newsletter for email" option - this ensures email compatibility</li>
                    <li>Test your newsletter by sending to yourself first</li>
                    <li>Images are automatically hosted on Imgur for maximum compatibility</li>
                    <li>Royal LePage branding colors are pre-configured in this builder</li>
                </ul>
            </div>
            
            <div style="background: #d1ecf1; border: 1px solid #17a2b8; border-radius: 6px; padding: 15px; margin-bottom: 20px;">
                <h5 style="color: #0c5460; margin-bottom: 8px;">💡 Pro Tips for RLP Sphere</h5>
                <ul style="color: #0c5460; margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.4;">
                    <li>Use the Royal LePage color preset for brand consistency</li>
                    <li>Keep subject lines under 50 characters for mobile optimization</li>
                    <li>Schedule sends for Tuesday-Thursday, 10 AM - 2 PM for best open rates</li>
                    <li>Include your MLS® data for the most current statistics</li>
                </ul>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn--primary" onclick="modalManager.close('rlpInstructionsModal')" style="flex: 1;">Got it!</button>
                <button type="button" class="btn btn--secondary" onclick="exportManager.copyEmailSafeHTML(); modalManager.close('rlpInstructionsModal');" style="flex: 1;">Copy Newsletter Now</button>
            </div>
        </div>
    </div>

    <section class="main-content">
        <div class="content-container">
            <div class="dashboard-container">
                <div class="sidebar">
                    <div class="app-header">
                        <h1>Newsletter Builder Pro</h1>
                        <p class="subtitle">Enhanced Real Estate Marketing</p>
                        <div class="edition-badge">
                            <strong id="currentMonth">August 2025 Edition</strong><br>
                            <small>🚀 Production Ready</small>
                        </div>
                    </div>
                    
                    <div class="form-content">
                        <div class="form-section fade-in">
                            <h3 class="form-section__header">🎨 Month & Banner Design</h3>
                            <div class="form-group">
                                <label class="form-group__label">Newsletter Month</label>
                                <select class="form-group__select" id="newsletterSeason">
                                    <option value="january">January - New Beginnings</option>
                                    <option value="february">February - Love Your Home</option>
                                    <option value="march">March - Spring Prep</option>
                                    <option value="april">April - Spring Awakening</option>
                                    <option value="may">May - Blooming Season</option>
                                    <option value="june">June - Summer Starts</option>
                                    <option value="july">July - Summer Living</option>
                                    <option value="august" selected>August - Late Summer</option>
                                    <option value="september">September - Fall Prep</option>
                                    <option value="october">October - Autumn Comfort</option>
                                    <option value="november">November - Thanksgiving Season</option>
                                    <option value="december">December - Holiday Season</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-group__label">Banner Style</label>
                                <select class="form-group__select" id="bannerStyle">
                                    <option value="mountains" selected>Mountains</option>
                                    <option value="cityscape">City Skyline</option>
                                    <option value="blueprint">Blueprint</option>
                                    <option value="minimal">Clean Minimal</option>
                                    <option value="custom">Custom Banner Image</option>
                                    <option value="none">No Banner</option>
                                </select>
                            </div>
                            
                            <div class="form-group" id="customBannerUpload" style="display: none;">
                                <label class="form-group__label">Custom Banner Image</label>
                                <input type="file" class="form-group__input" id="customBanner" accept="image/*" onchange="handleImageUpload('customBanner', 'customBanner')">
                                <div class="image-preview" id="customBannerPreview" style="margin-top: 10px; display: none;">
                                    <img style="width: 200px; height: 100px; object-fit: cover; border: 2px solid #ddd; border-radius: 4px;">
                                    <button type="button" onclick="removeImage('customBanner', 'customBanner')" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Remove</button>
                                </div>
                                <small>📏 Recommended size: 600x300px or similar landscape ratio</small>
                                
                                <div style="margin-top: 15px; padding: 15px; background: var(--background-light); border: 1px solid var(--border-color); border-radius: 6px;">
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin: 0;">
                                        <input type="checkbox" id="hideCustomBannerText" onchange="handleFormChange('hideCustomBannerText', this.checked)" style="width: 18px; height: 18px;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 500; color: var(--text-light); font-size: 14px;">Hide banner text overlay</div>
                                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">Remove the month/newsletter title text from your custom banner</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-group__label">Header Font</label>
                                    <select class="form-group__select" id="headerFont">
                                        <option value="'Playfair Display', serif" selected>Playfair Display</option>
                                        <option value="'Cormorant Garamond', serif">Cormorant Garamond</option>
                                        <option value="'Lora', serif">Lora</option>
                                        <option value="'Crimson Text', serif">Crimson Text</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-group__label">Body Font</label>
                                    <select class="form-group__select" id="bodyFont">
                                        <option value="'Montserrat', sans-serif" selected>Montserrat</option>
                                        <option value="'Raleway', sans-serif">Raleway</option>
                                        <option value="'Helvetica Neue', sans-serif">Helvetica Neue</option>
                                        <option value="Arial, sans-serif">Arial</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="margin-top: 25px; padding: 20px; background: var(--background-light); border: 1px solid var(--border-color); border-radius: 8px;">
                                <h4 style="color: var(--primary-color); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                                    🎨 Color Themes
                                </h4>
                                
                                <div class="form-row" style="margin-bottom: 15px;">
                                    <div class="form-group">
                                        <label class="form-group__label">Header Text Color</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="headerTextColor" value="#333333" onchange="handleFormChange('headerTextColor', this.value)" style="width: 60px; padding: 4px;">
                                            <input type="text" class="form-group__input" id="headerTextColorHex" value="#333333" oninput="handleColorHexChange('headerTextColor', 'headerTextColor', this.value)" placeholder="#333333" style="flex: 1; font-family: monospace;">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-group__label">Body Text Color</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="bodyTextColor" value="#555555" onchange="handleFormChange('bodyTextColor', this.value)" style="width: 60px; padding: 4px;">
                                            <input type="text" class="form-group__input" id="bodyTextColorHex" value="#555555" oninput="handleColorHexChange('bodyTextColor', 'bodyTextColor', this.value)" placeholder="#555555" style="flex: 1; font-family: monospace;">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row" style="margin-bottom: 15px;">
                                    <div class="form-group">
                                        <label class="form-group__label">Accent Color</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="accentColor" value="#f39c12" onchange="handleFormChange('accentColor', this.value)" style="width: 60px; padding: 4px;">
                                            <input type="text" class="form-group__input" id="accentColorHex" value="#f39c12" oninput="handleColorHexChange('accentColor', 'accentColor', this.value)" placeholder="#f39c12" style="flex: 1; font-family: monospace;">
                                        </div>
                                        <small>Used for borders, highlights, and emphasis</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-group__label">Background Accent</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="backgroundAccent" value="#f8f9fa" onchange="handleFormChange('backgroundAccent', this.value)" style="width: 60px; padding: 4px;">
                                            <input type="text" class="form-group__input" id="backgroundAccentHex" value="#f8f9fa" oninput="handleColorHexChange('backgroundAccent', 'backgroundAccent', this.value)" placeholder="#f8f9fa" style="flex: 1; font-family: monospace;">
                                        </div>
                                        <small>Background for message boxes and sections</small>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                                    <h5 style="color: var(--text-muted); font-size: 11px; font-weight: 600; text-transform: uppercase; margin-bottom: 10px;">Quick Color Presets (8 Available)</h5>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <button type="button" onclick="applyColorPreset('default')" class="quick-color-btn" style="background: linear-gradient(45deg, #f39c12, #e67e22); border: 2px solid #ddd;" title="Default Orange"></button>
                                        <button type="button" onclick="applyColorPreset('blue')" class="quick-color-btn" style="background: linear-gradient(45deg, #3498db, #2980b9); border: 2px solid #ddd;" title="Professional Blue"></button>
                                        <button type="button" onclick="applyColorPreset('green')" class="quick-color-btn" style="background: linear-gradient(45deg, #27ae60, #229954); border: 2px solid #ddd;" title="Nature Green"></button>
                                        <button type="button" onclick="applyColorPreset('purple')" class="quick-color-btn" style="background: linear-gradient(45deg, #9b59b6, #8e44ad); border: 2px solid #ddd;" title="Luxury Purple"></button>
                                        <button type="button" onclick="applyColorPreset('red')" class="quick-color-btn" style="background: linear-gradient(45deg, #e74c3c, #c0392b); border: 2px solid #ddd;" title="Bold Red"></button>
                                        <button type="button" onclick="applyColorPreset('teal')" class="quick-color-btn" style="background: linear-gradient(45deg, #1abc9c, #16a085); border: 2px solid #ddd;" title="Modern Teal"></button>
                                        <button type="button" onclick="applyColorPreset('dark')" class="quick-color-btn" style="background: linear-gradient(45deg, #2c3e50, #34495e); border: 2px solid #ddd;" title="Corporate Dark"></button>
                                        <button type="button" onclick="applyColorPreset('gold')" class="quick-color-btn" style="background: linear-gradient(45deg, #f1c40f, #f39c12); border: 2px solid #ddd;" title="Premium Gold"></button>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                                    <button type="button" onclick="applyColorPreset('royallepage')" class="btn" style="width: 100%; background: white; border: 2px solid #003087; color: #003087; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; padding: 15px 20px; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.background='#f8f9fa'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0,48,135,0.2)'" onmouseout="this.style.background='white'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                        <img src="https://i.imgur.com/5q2V1qG.png" style="height: 24px; width: auto; object-fit: contain;" alt="Royal LePage Logo">
                                        Apply Royal LePage Branding
                                        <img src="https://i.imgur.com/5q2V1qG.png" style="height: 24px; width: auto; object-fit: contain;" alt="Royal LePage Logo">
                                    </button>
                                    <div style="text-align: center; margin-top: 8px;">
                                        <small style="color: var(--text-muted); font-size: 11px;">Instantly applies official Royal LePage colors across your entire newsletter</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section fade-in">
                            <h3 class="form-section__header">💬 Personal Message</h3>
                            <div class="form-group">
                                <label class="form-group__label">Custom Subtitle</label>
                                <input type="text" class="form-group__input" id="customSubtitle" value="LATE SUMMER" placeholder="Enter custom subtitle...">
                                <div class="validation-message" id="customSubtitle-validation"></div>
                                <small>Leave blank to use default seasonal subtitle</small>
                            </div>
                            <div class="form-group">
                                <label class="form-group__label required-field">Opening Message</label>
                                <textarea class="form-group__textarea" id="personalMessage" rows="4" required>Before fall routines kick in, August is the perfect time to make a move or prep your home for sale. Let's chat about your next step!</textarea>
                                <div class="validation-message" id="personalMessage-validation"></div>
                                <small>Minimum 50 characters, maximum 1500 characters</small>
                            </div>
                        </div>
                        
                        <div class="form-section fade-in">
                            <h3 class="form-section__header">🔗 Smart Buttons</h3>
                            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 20px;">
                                Use Smart Buttons to quickly add clickable links to your newsletter. Just copy and paste any website URL to instantly direct readers to your website, buyer or seller guides, blogs, or any resource you choose. Simple, practical, and effective.
                            </p>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-group__label">🔘 Smart Button 1 Name</label>
                                    <input type="text" class="form-group__input" id="buyersGuideName" value="Button 1" oninput="handleFormChange('buyersGuideName', this.value)" placeholder="Button 1">
                                    <div class="validation-message" id="buyersGuideName-validation"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-group__label">Smart Button 1 URL</label>
                                    <input type="url" class="form-group__input" id="buyersGuideUrl" value="" oninput="handleFormChange('buyersGuideUrl', this.value)" placeholder="https://example.com/button1">
                                    <div class="validation-message" id="buyersGuideUrl-validation"></div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-group__label">🔘 Smart Button 2 Name</label>
                                    <input type="text" class="form-group__input" id="sellersGuideName" value="Button 2" oninput="handleFormChange('sellersGuideName', this.value)" placeholder="Button 2">
                                    <div class="validation-message" id="sellersGuideName-validation"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-group__label">Smart Button 2 URL</label>
                                    <input type="url" class="form-group__input" id="sellersGuideUrl" value="" oninput="handleFormChange('sellersGuideUrl', this.value)" placeholder="https://example.com/button2">
                                    <div class="validation-message" id="sellersGuideUrl-validation"></div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-group__label">🔘 Smart Button 3 Name</label>
                                    <input type="text" class="form-group__input" id="websiteName" value="Button 3" oninput="handleFormChange('websiteName', this.value)" placeholder="Button 3">
                                    <div class="validation-message" id="websiteName-validation"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-group__label">Smart Button 3 URL</label>
                                    <input type="url" class="form-group__input" id="myWebsiteUrl" value="" oninput="handleFormChange('myWebsiteUrl', this.value)" placeholder="https://example.com/button3">
                                    <div class="validation-message" id="myWebsiteUrl-validation"></div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-group__label">🔘 Smart Button 4 Name</label>
                                    <input type="text" class="form-group__input" id="blogName" value="Button 4" oninput="handleFormChange('blogName', this.value)" placeholder="Button 4">
                                    <div class="validation-message" id="blogName-validation"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-group__label">Smart Button 4 URL</label>
                                    <input type="url" class="form-group__input" id="blogUrl" value="" oninput="handleFormChange('blogUrl', this.value)" placeholder="https://example.com/button4">
                                    <div class="validation-message" id="blogUrl-validation"></div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 25px; padding: 20px; background: var(--background-light); border: 1px solid var(--border-color); border-radius: 8px;">
                                <h4 style="color: var(--primary-color); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                                    🎨 Smart Button Colors
                                </h4>
                                
                                <div class="form-row" style="margin-bottom: 10px;">
                                    <div class="form-group">
                                        <label class="form-group__label">Smart Button 1</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="buyersGuideColor" value="#f39c12" onchange="handleFormChange('buyersGuideColor', this.value)" style="width: 50px; padding: 2px;">
                                            <input type="text" class="form-group__input" id="buyersGuideColorHex" value="#f39c12" oninput="handleColorHexChange('buyersGuideColor', 'buyersGuideColor', this.value)" style="flex: 1; font-family: monospace;">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-group__label">Smart Button 2</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="sellersGuideColor" value="#2c3e50" onchange="handleFormChange('sellersGuideColor', this.value)" style="width: 50px; padding: 2px;">
                                            <input type="text" class="form-group__input" id="sellersGuideColorHex" value="#2c3e50" oninput="handleColorHexChange('sellersGuideColor', 'sellersGuideColor', this.value)" style="flex: 1; font-family: monospace;">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-group__label">Smart Button 3</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="websiteColor" value="#27ae60" onchange="handleFormChange('websiteColor', this.value)" style="width: 50px; padding: 2px;">
                                            <input type="text" class="form-group__input" id="websiteColorHex" value="#27ae60" oninput="handleColorHexChange('websiteColor', 'websiteColor', this.value)" style="flex: 1; font-family: monospace;">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-group__label">Smart Button 4</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="blogColor" value="#3498db" onchange="handleFormChange('blogColor', this.value)" style="width: 50px; padding: 2px;">
                                            <input type="text" class="form-group__input" id="blogColorHex" value="#3498db" oninput="handleColorHexChange('blogColor', 'blogColor', this.value)" style="flex: 1; font-family: monospace;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section fade-in">
                            <h3 class="form-section__header">📊 Market Statistics</h3>
                            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 20px;">
                                Enter your market statistics manually. The system will organize them into a professional layout.
                            </p>
                            
                            <div class="stats-grid" id="statsGrid">
                            </div>
                            
                            <div id="customPropertyTypesContainer">
                            </div>
                            
                            <button type="button" class="btn" onclick="modalManager.show('addCustomPropertyTypeModal')" style="margin: 20px 0; width: 100%; background: #f39c12; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; min-height: 44px;" onmouseover="this.style.background='#e67e22'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(243, 156, 18, 0.3)'" onmouseout="this.style.background='#f39c12'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                + Add Custom Property Type
                            </button>
                            
                            <div style="margin: 25px 0; padding: 20px; background: var(--background-light); border: 1px solid var(--border-color); border-radius: 8px;">
                                <h4 style="color: var(--primary-color); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                                    🎨 Property Type Colors
                                </h4>
                                
                                <div class="form-row" style="margin-bottom: 10px;">
                                    <div class="form-group">
                                        <label class="form-group__label">🏠 Detached Homes</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="detachedColor" value="#f39c12" onchange="handleFormChange('detachedColor', this.value)" style="width: 50px; padding: 2px;">
                                            <input type="text" class="form-group__input" id="detachedColorHex" value="#f39c12" oninput="handleColorHexChange('detachedColor', 'detachedColor', this.value)" style="flex: 1; font-family: monospace;">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-group__label">🏘️ Semi-Detached</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="semiColor" value="#2c3e50" onchange="handleFormChange('semiColor', this.value)" style="width: 50px; padding: 2px;">
                                            <input type="text" class="form-group__input" id="semiColorHex" value="#2c3e50" oninput="handleColorHexChange('semiColor', 'semiColor', this.value)" style="flex: 1; font-family: monospace;">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-group__label">🏘️ Row/Townhomes</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="rowColor" value="#27ae60" onchange="handleFormChange('rowColor', this.value)" style="width: 50px; padding: 2px;">
                                            <input type="text" class="form-group__input" id="rowColorHex" value="#27ae60" oninput="handleColorHexChange('rowColor', 'rowColor', this.value)" style="flex: 1; font-family: monospace;">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-group__label">🏢 Apartments/Condos</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="apartmentColor" value="#3498db" onchange="handleFormChange('apartmentColor', this.value)" style="width: 50px; padding: 2px;">
                                            <input type="text" class="form-group__input" id="apartmentColorHex" value="#3498db" oninput="handleColorHexChange('apartmentColor', 'apartmentColor', this.value)" style="flex: 1; font-family: monospace;">
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-top: 15px;">
                                    <div class="form-group">
                                        <label class="form-group__label">Custom Property Types</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="customPropertyColor" value="#9b59b6" onchange="handleFormChange('customPropertyColor', this.value)" style="width: 50px; padding: 2px;">
                                            <input type="text" class="form-group__input" id="customPropertyColorHex" value="#9b59b6" oninput="handleColorHexChange('customPropertyColor', 'customPropertyColor', this.value)" style="flex: 1; font-family: monospace;">
                                        </div>
                                        <small>Color used for all custom property types you add</small>
                                    </div>
                                </div>
                            </div>
                            
                            <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
                            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 15px;">
                                📄 Optional call-to-action smart button after market analysis
                            </p>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-group__label">Smart Button Text (Optional)</label>
                                    <input type="text" class="form-group__input" id="marketButtonText" value="" oninput="handleFormChange('marketButtonText', this.value)" placeholder="View Full Market Report">
                                    <div class="validation-message" id="marketButtonText-validation"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-group__label">Smart Button URL (Optional)</label>
                                    <input type="url" class="form-group__input" id="marketButtonUrl" value="" oninput="handleFormChange('marketButtonUrl', this.value)" placeholder="https://example.com/market-report">
                                    <div class="validation-message" id="marketButtonUrl-validation"></div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-group__label">Smart Button Color</label>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input type="color" class="form-group__input" id="marketButtonColor" value="#f39c12" onchange="handleFormChange('marketButtonColor', this.value)" style="width: 50px; padding: 2px;">
                                        <input type="text" class="form-group__input" id="marketButtonColorHex" value="#f39c12" oninput="handleColorHexChange('marketButtonColor', 'marketButtonColor', this.value)" style="flex: 1; font-family: monospace;">
                                    </div>
                                </div>
                                <div class="form-group">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section fade-in">
                            <h3 class="form-section__header">🔧 Monthly Maintenance Tips</h3>
                            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 15px;">
                                Manage maintenance tips for the selected month. Tips automatically update when you change months.
                            </p>
                            
                            <div id="maintenanceTipsSummary" style="margin-bottom: 20px; padding: 15px; background: var(--background-light); border: 1px solid var(--border-color); border-radius: 6px;">
                            </div>
                            
                            <button type="button" class="btn btn--primary btn--full" onclick="openMaintenanceTipsModal()">
                                🔧 Manage Maintenance Tips
                            </button>
                        </div>
                        
                        <div class="form-section fade-in">
                            <h3 class="form-section__header">📅 Community Calendar & Events</h3>
                            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 15px;">
                                Add your community events with optional images automatically hosted on Imgur for email compatibility.
                            </p>
                            <button type="button" class="btn btn--primary btn--full" onclick="modalManager.show('addEventModal')">
                                + Add Event
                            </button>
                            <div id="customEventsList" style="margin-top: 15px;">
                            </div>
                        </div>
                        
                        <div class="form-section fade-in">
                            <h3 class="form-section__header">👤 Your Information</h3>
                            <div class="form-group">
                                <label class="form-group__label required-field">Full Name</label>
                                <input type="text" class="form-group__input" id="agentName" value="" required>
                                <div class="validation-message" id="agentName-validation"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-group__label required-field">Company Name</label>
                                <input type="text" class="form-group__input" id="companyName" value="" required>
                                <div class="validation-message" id="companyName-validation"></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-group__label required-field">Phone</label>
                                    <input type="tel" class="form-group__input" id="agentPhone" value="" required>
                                    <div class="validation-message" id="agentPhone-validation"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-group__label required-field">Email</label>
                                    <input type="email" class="form-group__input" id="agentEmail" value="" required>
                                    <div class="validation-message" id="agentEmail-validation"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-group__label required-field">Website</label>
                                <input type="url" class="form-group__input" id="agentWebsite" value="" required>
                                <div class="validation-message" id="agentWebsite-validation"></div>
                            </div>
                            
                            <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
                            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 15px;">
                                📷 Upload your professional photos and logos (automatically hosted on Imgur)
                            </p>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-group__label">Agent Photo</label>
                                    <input type="file" class="form-group__input" id="agentPhoto" accept="image/*" onchange="handleImageUpload('agentPhoto', 'agentPhoto')">
                                    <div class="image-preview" id="agentPhotoPreview" style="margin-top: 10px; display: none;">
                                        <img style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd;">
                                        <button type="button" onclick="removeImage('agentPhoto', 'agentPhoto')" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Remove</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-group__label">Agent Logo</label>
                                    <input type="file" class="form-group__input" id="agentLogo" accept="image/*" onchange="handleImageUpload('agentLogo', 'agentLogo')">
                                    <div class="image-preview" id="agentLogoPreview" style="margin-top: 10px; display: none;">
                                        <img style="width: 80px; height: 60px; object-fit: contain; border: 2px solid #ddd; border-radius: 4px;">
                                        <button type="button" onclick="removeImage('agentLogo', 'agentLogo')" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Remove</button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-group__label">Brokerage Logo</label>
                                <input type="file" class="form-group__input" id="brokerageLogo" accept="image/*" onchange="handleImageUpload('brokerageLogo', 'brokerageLogo')">
                                <div class="image-preview" id="brokerageLogoPreview" style="margin-top: 10px; display: none;">
                                    <img style="width: 120px; height: 60px; object-fit: contain; border: 2px solid #ddd; border-radius: 4px;">
                                    <button type="button" onclick="removeImage('brokerageLogo', 'brokerageLogo')" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Remove</button>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn btn--primary btn--full" onclick="generateNewsletter()" style="font-size: 16px; padding: 16px 24px;">
                            ✨ Generate Newsletter
                        </button>
                    </div>
                </div>

                <div class="preview-container">
                    <div class="preview-header">
                        <button onclick="toggleInstructionsPopup()" class="btn btn--primary" style="font-size: 14px; padding: 12px 24px;">
                            📖 Quick User Guide
                        </button>
                        
                        <div id="instructionsPopup" style="display: none; margin-top: 20px; padding: 20px; background: white; border: 2px solid var(--primary-color); border-radius: 12px; text-align: left; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                            <h3 style="color: var(--primary-color); margin-bottom: 15px; font-size: 18px;">🚀 Quick Start Guide</h3>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--text-light); font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                    <span style="background: var(--primary-color); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">1</span>
                                    Choose Your Month & Style
                                </h4>
                                <p style="margin: 0 0 0 32px; font-size: 13px; color: var(--text-muted); line-height: 1.4;">Select your newsletter month and banner style. Try the Royal LePage branding button for instant professional colors!</p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--text-light); font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                    <span style="background: var(--primary-color); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">2</span>
                                    Add Your Personal Message
                                </h4>
                                <p style="margin: 0 0 0 32px; font-size: 13px; color: var(--text-muted); line-height: 1.4;">Write your opening message and customize Smart Buttons by adding URLs to your website, guides, or resources.</p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--text-light); font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                    <span style="background: var(--primary-color); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">3</span>
                                    Enter Market Statistics
                                </h4>
                                <p style="margin: 0 0 0 32px; font-size: 13px; color: var(--text-muted); line-height: 1.4;">Fill in your local market data. You can edit property type names, add custom types, and customize colors.</p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--text-light); font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                    <span style="background: var(--primary-color); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">4</span>
                                    Add Events & Your Information
                                </h4>
                                <p style="margin: 0 0 0 32px; font-size: 13px; color: var(--text-muted); line-height: 1.4;">Include community events with images, update maintenance tips, and fill in your contact information and photos.</p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--text-light); font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                    <span style="background: var(--primary-color); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">5</span>
                                    Generate & Export
                                </h4>
                                <p style="margin: 0 0 0 32px; font-size: 13px; color: var(--text-muted); line-height: 1.4;">Click "Generate Newsletter" to see your preview, then use "Export Options" to copy for email, download HTML, or print.</p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--text-light); font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                    <span style="background: #EA002A; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">6</span>
                                    RLP Sphere Integration
                                </h4>
                                <p style="margin: 0 0 0 32px; font-size: 13px; color: var(--text-muted); line-height: 1.4;">For Royal LePage Sphere users: <a href="#" onclick="openRLPInstructions()" style="color: #EA002A; text-decoration: underline; font-weight: 500;">Click here for instructions</a> to paste your newsletter into RLP Sphere.</p>
                            </div>
                            
                            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                                <p style="margin: 0; font-size: 12px; color: var(--text-muted); text-align: center; font-style: italic;">
                                    💡 Tip: Use Ctrl/Cmd + Enter to quickly generate your newsletter at any time!
                                </p>
                            </div>
                            
                            <div style="text-align: center; margin-top: 15px;">
                                <button onclick="toggleInstructionsPopup()" style="background: var(--primary-color); color: white; border: none; border-radius: 6px; padding: 10px 20px; cursor: pointer; font-size: 13px; font-weight: 500;">
                                    Got it! 👍
                                </button>
                            </div>
                        </div>
                        
                        <p style="color: var(--text-muted); margin-top: 15px; font-size: 14px;">
                            <span id="previewStatus">📝 Start filling out the form to see your newsletter preview</span>
                        </p>
                    </div>
                    
                    <div class="newsletter-preview" id="newsletterPreview">
                    </div>
                    
                    <div class="preview-actions" style="padding-bottom: 20px;">
                        <button class="btn btn--primary" onclick="modalManager.show('exportModal')" style="font-size: 14px; padding: 12px 24px;">
                            📧 Export Options
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        // Global state
        let newsletterData = {
            design: {
                bannerStyle: 'mountains',
                headerFont: "'Playfair Display', serif",
                bodyFont: "'Montserrat', sans-serif",
                hideCustomBannerText: false,
                colors: {
                    headerText: '#333333',
                    bodyText: '#555555',
                    accent: '#f39c12',
                    background: '#f8f9fa'
                },
            defaultPropertyTypes: [
                {
                    id: 'detached',
                    name: 'Detached Homes',
                    icon: '🏠',
                    colorKey: 'detached',
                    required: false
                },
                {
                    id: 'semi',
                    name: 'Semi-Detached',
                    icon: '🏘️',
                    colorKey: 'semi',
                    required: false
                },
                {
                    id: 'row',
                    name: 'Row/Townhomes',
                    icon: '🏘️',
                    colorKey: 'row',
                    required: false
                },
                {
                    id: 'apartment',
                    name: 'Apartments/Condos',
                    icon: '🏢',
                    colorKey: 'apartment',
                    required: false
                }
            ],
                buttonColors: {
                    buyersGuide: '#f39c12',
                    sellersGuide: '#2c3e50',
                    website: '#27ae60',
                    blog: '#3498db',
                    marketReport: '#f39c12',
                    eventDetails: '#f39c12'
                },
                propertyTypeColors: {
                    detached: '#f39c12',
                    semi: '#2c3e50',
                    row: '#27ae60',
                    apartment: '#3498db',
                    custom: '#9b59b6'
                }
            },
            images: {
                currentEventImage: null,
                agentPhoto: null,
                agentLogo: null,
                brokerageLogo: null,
                customBanner: null
            },
            stats: {
                avgPrice: '$589,900',
                priceChange: '-2.5%',
                homesSold: '2,568',
                salesChange: '-16.9%',
                newListings: '4,842',
                listingsChange: '+11.6%',
                inventory: '6,740',
                inventoryChange: '+97.5%',
                monthsOfSupply: '2.62',
                supplyChange: '+137.7%',
                
                detachedPrice: '$769,400',
                detachedChange: '+1.0%',
                detachedSales: '1,275',
                detachedSalesChange: '-8%',
                detachedListings: '2,419',
                detachedListingsChange: '+19%',
                detachedInventory: '2,995',
                detachedInventoryChange: '+87%',
                detachedSupply: '2.35',
                
                semiPrice: '$697,300',
                semiChange: '+2.8%',
                semiSales: '256',
                semiSalesChange: '-1%',
                semiListings: '428',
                semiListingsChange: '+19%',
                semiInventory: '542',
                semiInventoryChange: '+99%',
                semiSupply: '2.12',
                
                rowPrice: '$453,600',
                rowChange: '-1.9%',
                rowSales: '458',
                rowSalesChange: '-15%',
                rowListings: '764',
                rowListingsChange: '+11%',
                rowInventory: '1,116',
                rowInventoryChange: '+161%',
                rowSupply: '2.44',
                
                apartmentPrice: '$335,300',
                apartmentChange: '-1.5%',
                apartmentSales: '579',
                apartmentSalesChange: '-36%',
                apartmentListings: '1,231',
                apartmentListingsChange: '-2%',
                apartmentInventory: '2,087',
                apartmentInventoryChange: '+88%',
                apartmentSupply: '3.60'
            },
            agent: {
                name: '',
                company: '',
                phone: '',
                email: '',
                website: '',
                smartButtons: {
                    buyersGuide: {
                        name: 'Button 1',
                        url: ''
                    },
                    sellersGuide: {
                        name: 'Button 2', 
                        url: ''
                    },
                    website: {
                        name: 'Button 3',
                        url: ''
                    },
                    blog: {
                        name: 'Button 4',
                        url: ''
                    }
                }
            },
            content: {
                personalMessage: 'Before fall routines kick in, August is the perfect time to make a move or prep your home for sale. Let\'s chat about your next step!',
                newsletterSeason: 'august',
                customSubtitle: 'LATE SUMMER',
                marketButtonText: '',
                marketButtonUrl: ''
            },
            customPropertyTypes: [],
            customEvents: [],
            maintenanceTips: [
                '🏠 Review roof for hail damage',
                '🔥 Prep furnace for fall (early servicing)', 
                '🧹 Deep clean garage or shed',
                '📋 Plan fall landscaping or repairs',
                '🎨 Touch up exterior paint'
            ]
        };

        // Season configurations
        const SEASONS = {
            january: {
                title: 'JANUARY NEWSLETTER',
                subtitle: 'NEW BEGINNINGS',
                personalMessage: 'Happy New Year! A fresh start brings new opportunities—whether it\'s upgrading your space or buying your first home. Let\'s make 2025 the year of great moves!',
                tips: ['🔧 Replace furnace filter', '💧 Use humidifier to combat dry air', '🧊 Watch for ice dams after Chinooks', '❄️ Check for frost in attic/basement', '🚨 Test smoke & CO detectors']
            },
            february: {
                title: 'FEBRUARY NEWSLETTER',
                subtitle: 'LOVE YOUR HOME',
                personalMessage: 'Love is in the air—and so is opportunity! Whether you\'re buying, selling, or just curious, I\'m here to help you find a home you\'ll love.',
                tips: ['🌨️ Clear snow from foundation & vents', '🚪 Inspect weather stripping after freeze-thaw', '🔐 Lubricate locks & garage mechanisms', '💧 Monitor for condensation inside windows', '⚡ Test sump pump for early thaw']
            },
            march: {
                title: 'MARCH NEWSLETTER',
                subtitle: 'SPRING PREP',
                personalMessage: 'As the snow melts and days grow longer, now\'s the time to start thinking spring market. Real estate is warming up—are you ready?',
                tips: ['☀️ Begin clearing snow from perimeter', '💧 Check grading for pooling meltwater', '🏠 Book roof inspection before spring rain', '🌳 Trim snow-damaged tree limbs', '🌱 Prep garden tools & order supplies']
            },
            april: {
                title: 'APRIL NEWSLETTER',
                subtitle: 'SPRING AWAKENING',
                personalMessage: 'Spring is in full swing! It\'s a great time to freshen up your home or explore new listings. Let\'s talk about what\'s happening in your area.',
                tips: ['🌧️ Clean gutters/downspouts', '🏠 Inspect shingles & siding for winter damage', '💧 Test exterior taps (after final frost)', '🔧 Caulk windows and doors', '🌿 Fertilize lawn (spring mix)']
            },
            may: {
                title: 'MAY NEWSLETTER',
                subtitle: 'BLOOMING SEASON',
                personalMessage: 'May is for patios, gardening, and maybe even new beginnings. If you\'ve been thinking of a move, the spring market is buzzing!',
                tips: ['🚿 Power wash siding, deck, walkways', '💧 Inspect irrigation system for leaks', '🔧 Reseal driveway and deck surfaces', '🍖 Clean BBQ and prep outdoor living space', '🐛 Monitor for signs of pests and insects']
            },
            june: {
                title: 'JUNE NEWSLETTER',
                subtitle: 'SUMMER STARTS',
                personalMessage: 'With school winding down and the sun heating up, June is a top month for real estate. Let\'s make your next move a smooth one.',
                tips: ['❄️ Test A/C and change filters', '🌧️ Check eavestrough slope and extension', '🔧 Inspect fence posts for shifting', '🪟 Wash windows and inspect screens', '💨 Secure patio furniture before windstorms']
            },
            july: {
                title: 'JULY NEWSLETTER',
                subtitle: 'SUMMER LIVING',
                personalMessage: 'It\'s summer fun and sunshine! The market\'s still active, and I\'m here to help you take the next step—whether you\'re buying or selling.',
                tips: ['🌳 Trim trees near home (hail + wind risk)', '🏠 Check attic insulation and ventilation', '☀️ Use UV films or blinds on sunny windows', '💧 Water lawn early mornings (drought)', '🔥 Inspect dryer vent (fire safety)']
            },
            august: {
                title: 'AUGUST NEWSLETTER',
                subtitle: 'LATE SUMMER',
                personalMessage: 'Before fall routines kick in, August is the perfect time to make a move or prep your home for sale. Let\'s chat about your next step!',
                tips: ['🏠 Review roof for hail damage', '🔥 Prep furnace for fall (early servicing)', '🧹 Deep clean garage or shed', '📋 Plan fall landscaping or repairs', '🎨 Touch up exterior paint']
            },
            september: {
                title: 'SEPTEMBER NEWSLETTER',
                subtitle: 'FALL PREP',
                personalMessage: 'As routines return and leaves begin to turn, it\'s a great time to revisit your real estate goals. Fall can be full of opportunity!',
                tips: ['💧 Blow out sprinklers before frost', '🌿 Fertilize lawn (fall mix)', '🔥 Inspect chimney and fireplace', '📦 Store summer tools and patio gear', '🐭 Check attic and garage for rodent entry']
            },
            october: {
                title: 'OCTOBER NEWSLETTER',
                subtitle: 'AUTUMN COMFORT',
                personalMessage: 'Fall is here and so is one of the coziest times to shop for a new place. Let\'s talk listings, market trends, or your real estate wish list!',
                tips: ['❄️ Winterize outdoor faucets and hoses', '🍂 Rake and compost leaves', '🏠 Inspect foundation for cracks', '🔥 Test heating system and thermostat', '🚪 Apply weather seal to doors/windows']
            },
            november: {
                title: 'NOVEMBER NEWSLETTER',
                subtitle: 'THANKSGIVING SEASON',
                personalMessage: 'Before the holiday rush, November is a great time to review your plans. Thinking of a move in the new year? Let\'s get ahead of it together.',
                tips: ['❄️ Prepare snow removal equipment', '❄️ Cover or store A/C units', '💡 Install exterior light timers', '🧊 Stock ice melt and emergency supplies', '🔧 Replace furnace filter']
            },
            december: {
                title: 'DECEMBER NEWSLETTER',
                subtitle: 'HOLIDAY SEASON',
                personalMessage: 'Wishing you a warm and peaceful holiday season! Whether you\'re cozy at home or planning a change in the new year, I\'m here when you need me.',
                tips: ['❄️ Clear snow from roof edges and vents', '🚨 Test CO detectors during peak furnace use', '💨 Check for drafts around windows', '🚶 Keep exits and walkways snow-free', '🏠 Inspect roof load if heavy snowfalls occur']
            }
        };

        // Imgur API integration
        const IMGUR_CLIENT_ID = '203a7e94dc049ff';
        
        async function uploadToImgur(file, imageKey) {
            try {
                showToast('📤 Uploading image to Imgur...', 'info', 2000);
                
                const base64 = await fileToBase64(file);
                const base64Data = base64.split(',')[1];
                
                const response = await fetch('https://api.imgur.com/3/image', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Client-ID ${IMGUR_CLIENT_ID}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: base64Data,
                        type: 'base64'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Imgur API error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.data && data.data.link) {
                    const imgurUrl = data.data.link;
                    newsletterData.images[imageKey] = imgurUrl;
                    updatePreview();
                    showToast('✅ Image uploaded successfully to Imgur!', 'success', 3000);
                    console.log('Imgur upload successful:', imgurUrl);
                    return imgurUrl;
                } else {
                    throw new Error('Imgur upload failed: ' + JSON.stringify(data));
                }
                
            } catch (error) {
                console.error('Imgur upload error:', error);
                
                if (IMGUR_CLIENT_ID === '203a7e94dc049ff') {
                    console.log('Trying alternative Client ID...');
                    return uploadToImgurAlternative(file, imageKey);
                }
                
                showToast('⚠️ Imgur upload failed. Using local preview for now.', 'warning', 4000);
                
                const localUrl = URL.createObjectURL(file);
                newsletterData.images[imageKey] = localUrl;
                updatePreview();
                return localUrl;
            }
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        async function uploadToImgurAlternative(file, imageKey) {
            try {
                const alternativeClientId = 'f5c99b60812c81a';
                showToast('📤 Trying alternative Imgur configuration...', 'info', 2000);
                
                const base64 = await fileToBase64(file);
                const base64Data = base64.split(',')[1];
                
                const response = await fetch('https://api.imgur.com/3/image', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Client-ID ${alternativeClientId}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: base64Data,
                        type: 'base64'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Alternative Imgur API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.data && data.data.link) {
                    const imgurUrl = data.data.link;
                    newsletterData.images[imageKey] = imgurUrl;
                    updatePreview();
                    showToast('✅ Image uploaded with alternative configuration!', 'success', 3000);
                    console.log('Alternative Imgur upload successful:', imgurUrl);
                    return imgurUrl;
                } else {
                    throw new Error('Alternative Imgur upload failed');
                }
                
            } catch (error) {
                console.error('Alternative Imgur upload error:', error);
                showToast('⚠️ All Imgur uploads failed. Using local preview.', 'warning', 4000);
                
                const localUrl = URL.createObjectURL(file);
                newsletterData.images[imageKey] = localUrl;
                updatePreview();
                return localUrl;
            }
        }

        function formatEventTime(startTime, endTime) {
            if (!startTime) return '';
            
            function formatTime(timeStr) {
                const [hours, minutes] = timeStr.split(':');
                const hour12 = hours % 12 || 12;
                const ampm = hours >= 12 ? 'PM' : 'AM';
                return `${hour12}:${minutes} ${ampm}`;
            }
            
            const formattedStart = formatTime(startTime);
            
            if (endTime) {
                const formattedEnd = formatTime(endTime);
                return `${formattedStart} - ${formattedEnd}`;
            }
            
            return formattedStart;
        }

        function formatEventDate(dateString) {
            const [year, month, day] = dateString.split('-');
            const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 
                               'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            return {
                month: monthNames[parseInt(month) - 1],
                day: parseInt(day)
            };
        }

        function handleImageUpload(inputId, imageKey) {
            const input = document.getElementById(inputId);
            const file = input.files[0];
            
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showToast('❌ Image size must be less than 5MB', 'error');
                    input.value = '';
                    return;
                }
                
                showImagePreview(inputId, null, 'uploading');
                
                uploadToImgur(file, imageKey).then(imgurUrl => {
                    if (imgurUrl) {
                        showImagePreview(inputId, imgurUrl, 'success');
                    } else {
                        document.getElementById(inputId + 'Preview').style.display = 'none';
                        input.value = '';
                    }
                });
            }

            document.addEventListener('keypress', (e) => {
                if (e.target.id === 'modalNewMaintenanceTip' && e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('modalEmojiPicker').style.display = 'none';
                    addModalMaintenanceTip();
                }
            });
        }

        function showImagePreview(inputId, imageSrc, status = 'success') {
            const preview = document.getElementById(inputId + 'Preview');
            const img = preview.querySelector('img');
            
            if (status === 'uploading') {
                preview.style.display = 'block';
                img.style.opacity = '0.5';
                img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iMzAiIHN0cm9rZT0iI2RkZCIgc3Ryb2tlLXdpZHRoPSI0Ii8+Cjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzk5OSI+4oGq4oGq4oGq8J+TpDwvdGV4dD4KPC9zdmc+';
            } else if (status === 'success' && imageSrc) {
                img.style.opacity = '1';
                img.src = imageSrc;
                preview.style.display = 'block';
            }
            
            const statusDiv = preview.querySelector('.upload-status') || document.createElement('div');
            statusDiv.className = 'upload-status';
            statusDiv.style.cssText = 'font-size: 11px; margin-top: 5px; padding: 4px 8px; border-radius: 4px;';
            
            if (status === 'uploading') {
                statusDiv.textContent = '⏳ Uploading...';
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';
            } else if (status === 'success') {
                statusDiv.textContent = '✅ Image loaded';
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
            }
            
            if (!preview.querySelector('.upload-status')) {
                preview.appendChild(statusDiv);
            }
        }

        function removeImage(inputId, imageKey) {
            newsletterData.images[imageKey] = null;
            document.getElementById(inputId).value = '';
            document.getElementById(inputId + 'Preview').style.display = 'none';
            updatePreview();
            showToast('🗑️ Image removed', 'info');
        }

        function removeEventImage() {
            newsletterData.images.currentEventImage = null;
            document.getElementById('eventImage').value = '';
            document.getElementById('eventImagePreview').style.display = 'none';
            showToast('🗑️ Event image removed', 'info');
        }

        function handleEventImageUpload() {
            const input = document.getElementById('eventImage');
            const file = input.files[0];
            
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showToast('❌ Image size must be less than 5MB', 'error');
                    input.value = '';
                    return;
                }
                
                showEventImagePreview(null, 'uploading');
                
                uploadToImgur(file, 'currentEventImage').then(imgurUrl => {
                    if (imgurUrl) {
                        showEventImagePreview(imgurUrl, 'success');
                    } else {
                        document.getElementById('eventImagePreview').style.display = 'none';
                        input.value = '';
                    }
                });
            }
        }

        function showEventImagePreview(imageSrc, status = 'success') {
            const preview = document.getElementById('eventImagePreview');
            const img = preview.querySelector('img');
            
            if (status === 'uploading') {
                preview.style.display = 'block';
                img.style.opacity = '0.5';
                img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjgwIiB2aWV3Qm94PSIwIDAgMTIwIDgwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjZjBmMGYwIiByeD0iNCIvPgo8dGV4dCB4PSI1MCUiIHk9IjUwJSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5OTkiPuKBquKBquKBqvCfk6Q8L3RleHQ+Cjwvc3ZnPg==';
            } else if (status === 'success' && imageSrc) {
                img.style.opacity = '1';
                img.src = imageSrc;
                preview.style.display = 'block';
            }
            
            const statusDiv = preview.querySelector('.upload-status') || document.createElement('div');
            statusDiv.className = 'upload-status';
            statusDiv.style.cssText = 'font-size: 11px; margin-top: 5px; padding: 4px 8px; border-radius: 4px;';
            
            if (status === 'uploading') {
                statusDiv.textContent = '⏳ Uploading...';
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';
            } else if (status === 'success') {
                statusDiv.textContent = '✅ Image loaded';
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
            }
            
            if (!preview.querySelector('.upload-status')) {
                preview.appendChild(statusDiv);
            }
        }

        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast--${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        const modalManager = {
            show: (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) modal.classList.add('modal-overlay--show');
            },
            close: (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('modal-overlay--show');
                    const form = modal.querySelector('form');
                    if (form) {
                        form.reset();
                        const validationMessages = form.querySelectorAll('.validation-message');
                        validationMessages.forEach(msg => {
                            msg.style.display = 'none';
                            msg.classList.remove('error', 'success', 'warning');
                        });
                        
                        if (modalId === 'addEventModal') {
                            newsletterData.images.currentEventImage = null;
                            document.getElementById('eventImagePreview').style.display = 'none';
                            document.getElementById('eventDetailsLink').value = '';
                        }
                        
                        if (modalId === 'maintenanceTipsModal') {
                            document.getElementById('modalEmojiPicker').style.display = 'none';
                            document.getElementById('modalNewMaintenanceTip').value = '';
                        }
                        
                        if (modalId === 'addCustomPropertyTypeModal') {
                            document.getElementById('customPropertyEmojiPicker').style.display = 'none';
                        }
                    }
                }
            }
        };

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                const modalId = e.target.id;
                modalManager.close(modalId);
            }
        });

        document.addEventListener('click', (e) => {
            const modalPicker = document.getElementById('modalEmojiPicker');
            const modalButton = e.target.closest('[onclick="toggleModalEmojiPicker()"]');
            const isInsideModalPicker = e.target.closest('#modalEmojiPicker');
            
            if (modalPicker && !modalButton && !isInsideModalPicker) {
                modalPicker.style.display = 'none';
            }
            
            const customPropertyPicker = document.getElementById('customPropertyEmojiPicker');
            const customPropertyButton = e.target.closest('[onclick="toggleCustomPropertyEmojiPicker()"]');
            const isInsideCustomPropertyPicker = e.target.closest('#customPropertyEmojiPicker');
            
            if (customPropertyPicker && !customPropertyButton && !isInsideCustomPropertyPicker) {
                customPropertyPicker.style.display = 'none';
            }
        });

        function handleFormChange(fieldId, value) {
            const fieldMap = {
                'bannerStyle': 'design.bannerStyle',
                'headerFont': 'design.headerFont',
                'bodyFont': 'design.bodyFont',
                'hideCustomBannerText': 'design.hideCustomBannerText',
                'headerTextColor': 'design.colors.headerText',
                'bodyTextColor': 'design.colors.bodyText',
                'accentColor': 'design.colors.accent',
                'backgroundAccent': 'design.colors.background',
                'buyersGuideColor': 'design.buttonColors.buyersGuide',
                'sellersGuideColor': 'design.buttonColors.sellersGuide',
                'websiteColor': 'design.buttonColors.website',
                'blogColor': 'design.buttonColors.blog',
                'marketButtonColor': 'design.buttonColors.marketReport',
                'detachedColor': 'design.propertyTypeColors.detached',
                'semiColor': 'design.propertyTypeColors.semi',
                'rowColor': 'design.propertyTypeColors.row',
                'apartmentColor': 'design.propertyTypeColors.apartment',
                'customPropertyColor': 'design.propertyTypeColors.custom',
                'newsletterSeason': 'content.newsletterSeason',
                'customSubtitle': 'content.customSubtitle',
                'agentName': 'agent.name',
                'companyName': 'agent.company',
                'agentPhone': 'agent.phone',
                'agentEmail': 'agent.email',
                'agentWebsite': 'agent.website',
                'personalMessage': 'content.personalMessage',
                'marketButtonText': 'content.marketButtonText',
                'marketButtonUrl': 'content.marketButtonUrl',
                'buyersGuideEnabled': 'agent.smartButtons.buyersGuide.enabled',
                'buyersGuideName': 'agent.smartButtons.buyersGuide.name',
                'buyersGuideUrl': 'agent.smartButtons.buyersGuide.url',
                'sellersGuideEnabled': 'agent.smartButtons.sellersGuide.enabled',
                'sellersGuideName': 'agent.smartButtons.sellersGuide.name',
                'sellersGuideUrl': 'agent.smartButtons.sellersGuide.url',
                'websiteEnabled': 'agent.smartButtons.website.enabled',
                'websiteName': 'agent.smartButtons.website.name',
                'myWebsiteUrl': 'agent.smartButtons.website.url',
                'blogEnabled': 'agent.smartButtons.blog.enabled',
                'blogName': 'agent.smartButtons.blog.name',
                'blogUrl': 'agent.smartButtons.blog.url',
                'avgPrice': 'stats.avgPrice',
                'priceChange': 'stats.priceChange',
                'daysOnMarket': 'stats.daysOnMarket',
                'homesSold': 'stats.homesSold',
                'salesChange': 'stats.salesChange',
                'newListings': 'stats.newListings',
                'listingsChange': 'stats.listingsChange',
                'inventory': 'stats.inventory',
                'inventoryChange': 'stats.inventoryChange',
                'monthsOfSupply': 'stats.monthsOfSupply',
                'supplyChange': 'stats.supplyChange',
                'detachedPrice': 'stats.detachedPrice',
                'detachedChange': 'stats.detachedChange',
                'detachedSales': 'stats.detachedSales',
                'detachedSalesChange': 'stats.detachedSalesChange',
                'detachedListings': 'stats.detachedListings',
                'detachedListingsChange': 'stats.detachedListingsChange',
                'detachedInventory': 'stats.detachedInventory',
                'detachedInventoryChange': 'stats.detachedInventoryChange',
                'detachedSupply': 'stats.detachedSupply',
                'semiPrice': 'stats.semiPrice',
                'semiChange': 'stats.semiChange',
                'semiSales': 'stats.semiSales',
                'semiSalesChange': 'stats.semiSalesChange',
                'semiListings': 'stats.semiListings',
                'semiListingsChange': 'stats.semiListingsChange',
                'semiInventory': 'stats.semiInventory',
                'semiInventoryChange': 'stats.semiInventoryChange',
                'semiSupply': 'stats.semiSupply',
                'rowPrice': 'stats.rowPrice',
                'rowChange': 'stats.rowChange',
                'rowSales': 'stats.rowSales',
                'rowSalesChange': 'stats.rowSalesChange',
                'rowListings': 'stats.rowListings',
                'rowListingsChange': 'stats.rowListingsChange',
                'rowInventory': 'stats.rowInventory',
                'rowInventoryChange': 'stats.rowInventoryChange',
                'rowSupply': 'stats.rowSupply',
                'apartmentPrice': 'stats.apartmentPrice',
                'apartmentChange': 'stats.apartmentChange',
                'apartmentSales': 'stats.apartmentSales',
                'apartmentSalesChange': 'stats.apartmentSalesChange',
                'apartmentListings': 'stats.apartmentListings',
                'apartmentListingsChange': 'stats.apartmentListingsChange',
                'apartmentInventory': 'stats.apartmentInventory',
                'apartmentInventoryChange': 'stats.apartmentInventoryChange',
                'apartmentSupply': 'stats.apartmentSupply'
            };
            
            if (fieldMap[fieldId]) {
                const keys = fieldMap[fieldId].split('.');
                let obj = newsletterData;
                for (let i = 0; i < keys.length - 1; i++) {
                    obj = obj[keys[i]];
                }
                obj[keys[keys.length - 1]] = value;
            }
            
            if (fieldId.endsWith('Color') && !fieldId.includes('Hex') && !fieldMap[fieldId]) {
                const propertyTypeId = fieldId.replace('Color', '');
                const propertyType = newsletterData.design.defaultPropertyTypes.find(pt => pt.id === propertyTypeId);
                if (propertyType) {
                    newsletterData.design.propertyTypeColors[propertyType.colorKey || propertyType.id] = value;
                }
            }
            
            if (fieldId.includes('Color') && !fieldId.includes('Hex')) {
                const hexFieldId = fieldId + 'Hex';
                const hexField = document.getElementById(hexFieldId);
                if (hexField) {
                    hexField.value = value;
                }
            }
            
            if (fieldId === 'bannerStyle') {
                const customUpload = document.getElementById('customBannerUpload');
                if (value === 'custom') {
                    customUpload.style.display = 'block';
                } else {
                    customUpload.style.display = 'none';
                    newsletterData.design.hideCustomBannerText = false;
                    const checkbox = document.getElementById('hideCustomBannerText');
                    if (checkbox) checkbox.checked = false;
                }
            }
            
            if (fieldId === 'marketButtonUrl') {
                if (value && !newsletterData.content.marketButtonText) {
                    newsletterData.content.marketButtonText = 'View Full Market Report';
                    const textField = document.getElementById('marketButtonText');
                    if (textField) {
                        textField.value = 'View Full Market Report';
                    }
                }
            }
            
            if (fieldId === 'newsletterSeason') {
                updateMonthDisplay();
                updateMaintenanceTipsForSeason(value);
                
                renderMaintenanceTipsSummary();
                
                const seasonConfig = SEASONS[value];
                if (seasonConfig) {
                    if (seasonConfig.personalMessage) {
                        const messageField = document.getElementById('personalMessage');
                        if (messageField) {
                            messageField.value = seasonConfig.personalMessage;
                            newsletterData.content.personalMessage = seasonConfig.personalMessage;
                        }
                    }
                    if (seasonConfig.subtitle) {
                        const subtitleField = document.getElementById('customSubtitle');
                        if (subtitleField) {
                            subtitleField.value = seasonConfig.subtitle;
                            newsletterData.content.customSubtitle = seasonConfig.subtitle;
                        }
                    }
                }
            }
            
            updatePreview();
        }

        function handleColorHexChange(colorPickerId, fieldId, hexValue) {
            if (/^#[0-9A-F]{6}$/i.test(hexValue)) {
                const colorPicker = document.getElementById(colorPickerId);
                if (colorPicker) {
                    colorPicker.value = hexValue;
                }
                handleFormChange(fieldId, hexValue);
            }
        }

        function applyColorPreset(presetName) {
            const presets = {
                default: {
                    colors: { headerText: '#333333', bodyText: '#555555', accent: '#f39c12', background: '#f8f9fa' },
                    buttons: { buyersGuide: '#f39c12', sellersGuide: '#2c3e50', website: '#27ae60', blog: '#3498db', marketReport: '#f39c12' },
                    propertyTypes: { detached: '#f39c12', semi: '#2c3e50', row: '#27ae60', apartment: '#3498db', custom: '#9b59b6' }
                },
                blue: {
                    colors: { headerText: '#2c3e50', bodyText: '#34495e', accent: '#3498db', background: '#ebf3fd' },
                    buttons: { buyersGuide: '#3498db', sellersGuide: '#2980b9', website: '#1abc9c', blog: '#9b59b6', marketReport: '#3498db' },
                    propertyTypes: { detached: '#3498db', semi: '#2980b9', row: '#1abc9c', apartment: '#9b59b6', custom: '#8e44ad' }
                },
                green: {
                    colors: { headerText: '#27ae60', bodyText: '#2e8b57', accent: '#27ae60', background: '#e8f8f0' },
                    buttons: { buyersGuide: '#27ae60', sellersGuide: '#229954', website: '#1abc9c', blog: '#f39c12', marketReport: '#27ae60' },
                    propertyTypes: { detached: '#27ae60', semi: '#229954', row: '#1abc9c', apartment: '#f39c12', custom: '#e67e22' }
                },
                purple: {
                    colors: { headerText: '#8e44ad', bodyText: '#6c3483', accent: '#9b59b6', background: '#f4ecf7' },
                    buttons: { buyersGuide: '#9b59b6', sellersGuide: '#8e44ad', website: '#e74c3c', blog: '#f39c12', marketReport: '#9b59b6' },
                    propertyTypes: { detached: '#9b59b6', semi: '#8e44ad', row: '#e74c3c', apartment: '#f39c12', custom: '#d68910' }
                },
                red: {
                    colors: { headerText: '#c0392b', bodyText: '#922b21', accent: '#e74c3c', background: '#fdf2f2' },
                    buttons: { buyersGuide: '#e74c3c', sellersGuide: '#c0392b', website: '#f39c12', blog: '#3498db', marketReport: '#e74c3c' },
                    propertyTypes: { detached: '#e74c3c', semi: '#c0392b', row: '#f39c12', apartment: '#3498db', custom: '#9b59b6' }
                },
                teal: {
                    colors: { headerText: '#16a085', bodyText: '#138d75', accent: '#1abc9c', background: '#e8f8f5' },
                    buttons: { buyersGuide: '#1abc9c', sellersGuide: '#16a085', website: '#27ae60', blog: '#3498db', marketReport: '#1abc9c' },
                    propertyTypes: { detached: '#1abc9c', semi: '#16a085', row: '#27ae60', apartment: '#3498db', custom: '#f39c12' }
                },
                dark: {
                    colors: { headerText: '#2c3e50', bodyText: '#34495e', accent: '#95a5a6', background: '#ecf0f1' },
                    buttons: { buyersGuide: '#34495e', sellersGuide: '#2c3e50', website: '#95a5a6', blog: '#7f8c8d', marketReport: '#95a5a6' },
                    propertyTypes: { detached: '#34495e', semi: '#2c3e50', row: '#95a5a6', apartment: '#7f8c8d', custom: '#566573' }
                },
                gold: {
                    colors: { headerText: '#b7950b', bodyText: '#9a7d0a', accent: '#f1c40f', background: '#fef9e7' },
                    buttons: { buyersGuide: '#f1c40f', sellersGuide: '#f39c12', website: '#e67e22', blog: '#d35400', marketReport: '#f1c40f' },
                    propertyTypes: { detached: '#f1c40f', semi: '#f39c12', row: '#e67e22', apartment: '#d35400', custom: '#ca6f1e' }
                },
                royallepage: {
                    colors: { headerText: '#000000', bodyText: '#4D4D4D', accent: '#EA002A', background: '#FFFFFF' },
                    buttons: { buyersGuide: '#EA002A', sellersGuide: '#000000', website: '#A59D95', blog: '#C4C18E', marketReport: '#EA002A' },
                    propertyTypes: { detached: '#EA002A', semi: '#000000', row: '#A59D95', apartment: '#4D4D4D', custom: '#C4C18E' }
                }
            };
            
            const preset = presets[presetName];
            if (!preset) return;
            
            newsletterData.design.colors = { ...preset.colors };
            newsletterData.design.buttonColors = { ...newsletterData.design.buttonColors, ...preset.buttons };
            newsletterData.design.propertyTypeColors = { ...preset.propertyTypes };
            
            updateColorInputs();
            updatePreview();
            
            const displayName = presetName === 'royallepage' ? 'Royal LePage' : presetName.charAt(0).toUpperCase() + presetName.slice(1);
            showToast(`🎨 Applied ${displayName} color preset!`, 'success', 3000);
        }

        function updateColorInputs() {
            const colorFields = [
                { id: 'headerTextColor', value: newsletterData.design.colors.headerText },
                { id: 'bodyTextColor', value: newsletterData.design.colors.bodyText },
                { id: 'accentColor', value: newsletterData.design.colors.accent },
                { id: 'backgroundAccent', value: newsletterData.design.colors.background },
                { id: 'buyersGuideColor', value: newsletterData.design.buttonColors.buyersGuide },
                { id: 'sellersGuideColor', value: newsletterData.design.buttonColors.sellersGuide },
                { id: 'websiteColor', value: newsletterData.design.buttonColors.website },
                { id: 'blogColor', value: newsletterData.design.buttonColors.blog },
                { id: 'marketButtonColor', value: newsletterData.design.buttonColors.marketReport },
                { id: 'detachedColor', value: newsletterData.design.propertyTypeColors.detached },
                { id: 'semiColor', value: newsletterData.design.propertyTypeColors.semi },
                { id: 'rowColor', value: newsletterData.design.propertyTypeColors.row },
                { id: 'apartmentColor', value: newsletterData.design.propertyTypeColors.apartment },
                { id: 'customPropertyColor', value: newsletterData.design.propertyTypeColors.custom }
            ];
            
            colorFields.forEach(field => {
                const colorInput = document.getElementById(field.id);
                const hexInput = document.getElementById(field.id + 'Hex');
                
                if (colorInput) colorInput.value = field.value;
                if (hexInput) hexInput.value = field.value;
            });
        }

        function renderStats() {
            const statsConfig = [
                { id: 'avgPrice', label: 'Total Residential Price', field: 'avgPrice', section: 'main' },
                { id: 'priceChange', label: 'Price Change Y/Y', field: 'priceChange', section: 'main' },
                { id: 'homesSold', label: 'Total Sales', field: 'homesSold', section: 'main' },
                { id: 'salesChange', label: 'Sales Change Y/Y', field: 'salesChange', section: 'main' },
                { id: 'newListings', label: 'Total New Listings', field: 'newListings', section: 'main' },
                { id: 'listingsChange', label: 'Listings Change Y/Y', field: 'listingsChange', section: 'main' },
                { id: 'inventory', label: 'Total Inventory', field: 'inventory', section: 'main' },
                { id: 'inventoryChange', label: 'Inventory Change Y/Y', field: 'inventoryChange', section: 'main' },
                { id: 'monthsOfSupply', label: 'Months of Supply', field: 'monthsOfSupply', section: 'main' },
                { id: 'supplyChange', label: 'Supply Change Y/Y', field: 'supplyChange', section: 'main' },
                
                { id: 'detachedPrice', label: 'Price', field: 'detachedPrice', section: 'detached' },
                { id: 'detachedChange', label: 'Price Change Y/Y', field: 'detachedChange', section: 'detached' },
                { id: 'detachedSales', label: 'Sales', field: 'detachedSales', section: 'detached' },
                { id: 'detachedSalesChange', label: 'Sales Change Y/Y', field: 'detachedSalesChange', section: 'detached' },
                { id: 'detachedListings', label: 'New Listings', field: 'detachedListings', section: 'detached' },
                { id: 'detachedListingsChange', label: 'Listings Change Y/Y', field: 'detachedListingsChange', section: 'detached' },
                { id: 'detachedInventory', label: 'Inventory', field: 'detachedInventory', section: 'detached' },
                { id: 'detachedSupply', label: 'Months Supply', field: 'detachedSupply', section: 'detached' },
                
                { id: 'semiPrice', label: 'Price', field: 'semiPrice', section: 'semi' },
                { id: 'semiChange', label: 'Price Change Y/Y', field: 'semiChange', section: 'semi' },
                { id: 'semiSales', label: 'Sales', field: 'semiSales', section: 'semi' },
                { id: 'semiSalesChange', label: 'Sales Change Y/Y', field: 'semiSalesChange', section: 'semi' },
                { id: 'semiListings', label: 'New Listings', field: 'semiListings', section: 'semi' },
                { id: 'semiListingsChange', label: 'Listings Change Y/Y', field: 'semiListingsChange', section: 'semi' },
                { id: 'semiInventory', label: 'Inventory', field: 'semiInventory', section: 'semi' },
                { id: 'semiSupply', label: 'Months Supply', field: 'semiSupply', section: 'semi' },
                
                { id: 'rowPrice', label: 'Price', field: 'rowPrice', section: 'row' },
                { id: 'rowChange', label: 'Price Change Y/Y', field: 'rowChange', section: 'row' },
                { id: 'rowSales', label: 'Sales', field: 'rowSales', section: 'row' },
                { id: 'rowSalesChange', label: 'Sales Change Y/Y', field: 'rowSalesChange', section: 'row' },
                { id: 'rowListings', label: 'New Listings', field: 'rowListings', section: 'row' },
                { id: 'rowListingsChange', label: 'Listings Change Y/Y', field: 'rowListingsChange', section: 'row' },
                { id: 'rowInventory', label: 'Inventory', field: 'rowInventory', section: 'row' },
                { id: 'rowSupply', label: 'Months Supply', field: 'rowSupply', section: 'row' },
                
                { id: 'apartmentPrice', label: 'Price', field: 'apartmentPrice', section: 'apartment' },
                { id: 'apartmentChange', label: 'Price Change Y/Y', field: 'apartmentChange', section: 'apartment' },
                { id: 'apartmentSales', label: 'Sales', field: 'apartmentSales', section: 'apartment' },
                { id: 'apartmentSalesChange', label: 'Sales Change Y/Y', field: 'apartmentSalesChange', section: 'apartment' },
                { id: 'apartmentListings', label: 'New Listings', field: 'apartmentListings', section: 'apartment' },
                { id: 'apartmentListingsChange', label: 'Listings Change Y/Y', field: 'apartmentListingsChange', section: 'apartment' },
                { id: 'apartmentInventory', label: 'Inventory', field: 'apartmentInventory', section: 'apartment' },
                { id: 'apartmentSupply', label: 'Months Supply', field: 'apartmentSupply', section: 'apartment' }
            ];

            const container = document.getElementById('statsGrid');
            
            const mainStats = statsConfig.filter(s => s.section === 'main');
            
            const activePropertyTypes = newsletterData.design.defaultPropertyTypes.filter(pt => !pt.deleted);
            
            let sectionsHtml = `
                <div style="margin-bottom: 25px;">
                    <div class="stats-section-header">📊 Main Market Indicators</div>
                    ${mainStats.map(stat => `
                        <div class="stat-item" style="margin-bottom: 8px;">
                            <label class="stat-item__label">${stat.label}</label>
                            <input type="text" class="stat-item__input" id="${stat.id}" value="${newsletterData.stats[stat.field] || ''}" oninput="handleFormChange('${stat.id}', this.value)">
                        </div>
                    `).join('')}
                </div>
            `;
            
            activePropertyTypes.forEach(propertyType => {
                const sectionStats = statsConfig.filter(s => s.section === propertyType.id);
                if (sectionStats.length > 0) {
                    sectionsHtml += `
                        <div style="margin-bottom: 25px;">
                            <div class="stats-section-header" style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
                                <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                    <span>${propertyType.icon}</span>
                                    <input type="text" value="${propertyType.name}" onchange="updatePropertyTypeName('${propertyType.id}', this.value)" style="background: transparent; border: none; color: var(--primary-color); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; flex: 1; min-width: 120px;" onclick="this.select()">
                                    <button onclick="editPropertyTypeIcon('${propertyType.id}')" style="background: none; border: none; cursor: pointer; font-size: 12px; color: var(--text-muted); padding: 2px 4px;" title="Change icon">✏️</button>
                                </div>
                                <button onclick="deletePropertyType('${propertyType.id}')" style="background: var(--danger-color); color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer;" title="Delete property type">Delete</button>
                            </div>
                            ${sectionStats.map(stat => `
                                <div class="stat-item" style="margin-bottom: 8px;">
                                    <label class="stat-item__label">${stat.label}</label>
                                    <input type="text" class="stat-item__input" id="${stat.id}" value="${newsletterData.stats[stat.field] || ''}" oninput="handleFormChange('${stat.id}', this.value)">
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            });
            
            container.innerHTML = sectionsHtml;
        }

        function updatePropertyTypeName(propertyTypeId, newName) {
            const propertyType = newsletterData.design.defaultPropertyTypes.find(pt => pt.id === propertyTypeId);
            if (propertyType) {
                propertyType.name = newName.trim();
                updatePreview();
                showToast('✅ Property type name updated', 'success', 2000);
            }
        }

        function editPropertyTypeIcon(propertyTypeId) {
            const propertyType = newsletterData.design.defaultPropertyTypes.find(pt => pt.id === propertyTypeId);
            if (propertyType) {
                const newIcon = prompt(`Enter new icon for "${propertyType.name}":`, propertyType.icon);
                if (newIcon !== null && newIcon.trim() !== '') {
                    propertyType.icon = newIcon.trim();
                    renderStats();
                    updatePreview();
                    showToast('✅ Property type icon updated', 'success', 2000);
                }
            }
        }

        function deletePropertyType(propertyTypeId) {
            const propertyType = newsletterData.design.defaultPropertyTypes.find(pt => pt.id === propertyTypeId);
            if (propertyType) {
                if (confirm(`Are you sure you want to delete "${propertyType.name}"? This will remove all associated statistics.`)) {
                    propertyType.deleted = true;
                    
                    const statsToDelete = [
                        `${propertyTypeId}Price`, `${propertyTypeId}Change`, `${propertyTypeId}Sales`, `${propertyTypeId}SalesChange`,
                        `${propertyTypeId}Listings`, `${propertyTypeId}ListingsChange`, `${propertyTypeId}Inventory`, 
                        `${propertyTypeId}InventoryChange`, `${propertyTypeId}Supply`
                    ];
                    
                    statsToDelete.forEach(statKey => {
                        if (newsletterData.stats[statKey]) {
                            delete newsletterData.stats[statKey];
                        }
                    });
                    
                    renderStats();
                    updatePropertyTypeColorInputs();
                    updatePreview();
                    showToast('✅ Property type deleted successfully', 'success');
                }
            }
        }

        function restorePropertyType(propertyTypeId) {
            const propertyType = newsletterData.design.defaultPropertyTypes.find(pt => pt.id === propertyTypeId);
            if (propertyType) {
                propertyType.deleted = false;
                renderStats();
                updatePropertyTypeColorInputs();
                updatePreview();
                showToast('✅ Property type restored', 'success');
            }
        }

        function updatePropertyTypeColorInputs() {
            const activePropertyTypes = newsletterData.design.defaultPropertyTypes.filter(pt => !pt.deleted);
            
            const propertyColorsSection = document.querySelector('[style*="Property Type Colors"]')?.parentElement;
            if (propertyColorsSection) {
                const colorInputsContainer = propertyColorsSection.querySelector('.form-row').parentElement;
                
                let propertyTypeColorInputs = '';
                const rows = [];
                
                for (let i = 0; i < activePropertyTypes.length; i += 2) {
                    const pt1 = activePropertyTypes[i];
                    const pt2 = activePropertyTypes[i + 1];
                    
                    let rowHtml = '<div class="form-row">';
                    
                    if (pt1) {
                        rowHtml += `
                            <div class="form-group">
                                <label class="form-group__label">${pt1.icon} ${pt1.name}</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="color" class="form-group__input" id="${pt1.id}Color" value="${newsletterData.design.propertyTypeColors[pt1.colorKey]}" onchange="handleFormChange('${pt1.id}Color', this.value)" style="width: 50px; padding: 2px;">
                                    <input type="text" class="form-group__input" id="${pt1.id}ColorHex" value="${newsletterData.design.propertyTypeColors[pt1.colorKey]}" oninput="handleColorHexChange('${pt1.id}Color', '${pt1.id}Color', this.value)" style="flex: 1; font-family: monospace;">
                                </div>
                            </div>
                        `;
                    }
                    
                    if (pt2) {
                        rowHtml += `
                            <div class="form-group">
                                <label class="form-group__label">${pt2.icon} ${pt2.name}</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="color" class="form-group__input" id="${pt2.id}Color" value="${newsletterData.design.propertyTypeColors[pt2.colorKey]}" onchange="handleFormChange('${pt2.id}Color', this.value)" style="width: 50px; padding: 2px;">
                                    <input type="text" class="form-group__input" id="${pt2.id}ColorHex" value="${newsletterData.design.propertyTypeColors[pt2.colorKey]}" oninput="handleColorHexChange('${pt2.id}Color', '${pt2.id}Color', this.value)" style="flex: 1; font-family: monospace;">
                                </div>
                            </div>
                        `;
                    } else {
                        rowHtml += '<div class="form-group"></div>';
                    }
                    
                    rowHtml += '</div>';
                    rows.push(rowHtml);
                }
                
                const customPropertyTypeHtml = `
                    <div style="margin-top: 15px;">
                        <div class="form-group">
                            <label class="form-group__label">Custom Property Types</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="color" class="form-group__input" id="customPropertyColor" value="${newsletterData.design.propertyTypeColors.custom}" onchange="handleFormChange('customPropertyColor', this.value)" style="width: 50px; padding: 2px;">
                                <input type="text" class="form-group__input" id="customPropertyColorHex" value="${newsletterData.design.propertyTypeColors.custom}" oninput="handleColorHexChange('customPropertyColor', 'customPropertyColor', this.value)" style="flex: 1; font-family: monospace;">
                            </div>
                            <small>Color used for all custom property types you add</small>
                        </div>
                    </div>
                `;
                
                colorInputsContainer.innerHTML = rows.join('') + customPropertyTypeHtml;
            }
        }

        function updateMonthDisplay() {
            const month = newsletterData.content.newsletterSeason || 'august';
            const monthName = month.charAt(0).toUpperCase() + month.slice(1);
            document.getElementById('currentMonth').textContent = `${monthName} 2025 Edition`;
        }

        function updateMaintenanceTipsForSeason(season) {
            const config = SEASONS[season];
            if (config && config.tips) {
                const currentTips = newsletterData.maintenanceTips || [];
                const hasCustomTips = currentTips.length > 0 && !isDefaultTips(currentTips, season);
                
                if (!hasCustomTips) {
                    newsletterData.maintenanceTips = [...config.tips];
                    renderMaintenanceTipsSummary();
                }
            }
        }

        function isDefaultTips(currentTips, season) {
            const defaultTips = SEASONS[season]?.tips || [];
            if (currentTips.length !== defaultTips.length) return false;
            
            return currentTips.every((tip, index) => tip === defaultTips[index]);
        }

        function getMaintenanceTips(config) {
            const tips = newsletterData.maintenanceTips || config.tips;
            console.log('Getting maintenance tips:', tips);
            return tips;
        }

        function renderMaintenanceTipsSummary() {
            const container = document.getElementById('maintenanceTipsSummary');
            
            if (!newsletterData.maintenanceTips || newsletterData.maintenanceTips.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 15px; color: var(--text-muted); font-style: italic; font-size: 14px;">
                        No maintenance tips added yet
                    </div>
                `;
                return;
            }
            
            const tipCount = newsletterData.maintenanceTips.length;
            const firstFewTips = newsletterData.maintenanceTips.slice(0, 3);
            
            container.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong style="color: var(--primary-color);">${tipCount} Maintenance Tip${tipCount !== 1 ? 's' : ''}</strong>
                </div>
                <div style="font-size: 13px; line-height: 1.4;">
                    ${firstFewTips.map(tip => `<div style="margin-bottom: 5px; color: var(--text-muted);">${tip}</div>`).join('')}
                    ${tipCount > 3 ? `<div style="color: var(--text-secondary); font-style: italic; margin-top: 8px;">...and ${tipCount - 3} more tip${tipCount - 3 !== 1 ? 's' : ''}</div>` : ''}
                </div>
            `;
        }

        function renderModalMaintenanceTips() {
            const container = document.getElementById('modalMaintenanceTipsList');
            
            if (!newsletterData.maintenanceTips || newsletterData.maintenanceTips.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-muted); font-style: italic; font-size: 14px;">
                        No maintenance tips added yet
                    </div>
                `;
                return;
            }
            
            container.innerHTML = newsletterData.maintenanceTips.map((tip, index) => `
                <div class="event-item" style="margin-bottom: 10px; padding: 15px;">
                    <button class="event-delete" onclick="deleteModalMaintenanceTip(${index})" title="Delete tip" style="width: 25px; height: 25px; min-width: 25px; min-height: 25px;">×</button>
                    <div style="padding-right: 35px;">
                        <input type="text" value="${tip}" onchange="updateModalMaintenanceTip(${index}, this.value)" onclick="this.select()" style="width: 100%; background: transparent; border: 1px solid transparent; padding: 5px; border-radius: 4px; font-size: 14px; color: var(--text-light);" onmouseover="this.style.border='1px solid var(--border-color)'" onmouseout="this.style.border='1px solid transparent'" onfocus="this.style.border='1px solid var(--primary-color)'">
                    </div>
                </div>
            `).join('');
        }

        function openMaintenanceTipsModal() {
            const currentMonth = newsletterData.content.newsletterSeason;
            const monthName = currentMonth.charAt(0).toUpperCase() + currentMonth.slice(1);
            document.getElementById('modalCurrentMonth').textContent = monthName;
            
            renderModalMaintenanceTips();
            
            document.getElementById('modalEmojiPicker').style.display = 'none';
            
            document.getElementById('modalNewMaintenanceTip').value = '';
            
            modalManager.show('maintenanceTipsModal');
        }

        function toggleModalEmojiPicker() {
            const picker = document.getElementById('modalEmojiPicker');
            const isVisible = picker.style.display !== 'none';
            picker.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                document.getElementById('modalNewMaintenanceTip').focus();
            }
        }

        function insertModalEmoji(emoji) {
            const input = document.getElementById('modalNewMaintenanceTip');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            
            const newText = text.substring(0, start) + emoji + ' ' + text.substring(end);
            input.value = newText;
            
            const newCursorPos = start + emoji.length + 1;
            input.setSelectionRange(newCursorPos, newCursorPos);
            input.focus();
            
            document.getElementById('modalEmojiPicker').style.display = 'none';
            
            showToast(`Added ${emoji} emoji`, 'success', 1500);
        }

        function addModalMaintenanceTip() {
            const input = document.getElementById('modalNewMaintenanceTip');
            const tip = input.value.trim();
            
            if (!tip) {
                showToast('❌ Please enter a tip', 'error');
                return;
            }
            
            const formattedTip = tip.match(/^[\u{1F300}-\u{1F9FF}]|^[\u{2600}-\u{27BF}]/u) ? tip : `🔧 ${tip}`;
            
            if (!newsletterData.maintenanceTips) {
                newsletterData.maintenanceTips = [];
            }
            
            newsletterData.maintenanceTips.push(formattedTip);
            input.value = '';
            
            console.log('Added maintenance tip:', formattedTip);
            console.log('All maintenance tips:', newsletterData.maintenanceTips);
            
            document.getElementById('modalEmojiPicker').style.display = 'none';
            
            renderModalMaintenanceTips();
            renderMaintenanceTipsSummary();
            updatePreview();
            showToast('✅ Maintenance tip added!', 'success');
        }

        function updateModalMaintenanceTip(index, newTip) {
            if (newsletterData.maintenanceTips && newsletterData.maintenanceTips[index] !== undefined) {
                newsletterData.maintenanceTips[index] = newTip.trim();
                renderMaintenanceTipsSummary();
                updatePreview();
                showToast('✅ Tip updated', 'success', 2000);
            }
        }

        function deleteModalMaintenanceTip(index) {
            if (confirm('Are you sure you want to delete this maintenance tip?')) {
                newsletterData.maintenanceTips.splice(index, 1);
                renderModalMaintenanceTips();
                renderMaintenanceTipsSummary();
                updatePreview();
                showToast('✅ Maintenance tip deleted', 'success');
            }
        }

        function resetToDefaultTips() {
            const season = newsletterData.content.newsletterSeason;
            const config = SEASONS[season];
            
            if (confirm(`Are you sure you want to reset to the default ${season} maintenance tips? This will remove all your custom tips.`)) {
                newsletterData.maintenanceTips = [...config.tips];
                renderModalMaintenanceTips();
                renderMaintenanceTipsSummary();
                updatePreview();
                showToast('🔄 Reset to default seasonal tips', 'success');
            }
        }

        function updateEventsList() {
            const container = document.getElementById('customEventsList');
            
            if (!newsletterData.customEvents || newsletterData.customEvents.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-muted); font-style: italic; font-size: 14px;">
                        No events added yet
                    </div>
                `;
                return;
            }
            
            const sortedEvents = newsletterData.customEvents
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            container.innerHTML = sortedEvents.map(event => `
                <div class="event-item" style="margin-top: 10px;">
                    <button class="event-delete" onclick="deleteEvent('${event.id}')" title="Delete event">×</button>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        ${event.image ? `
                        <div style="flex-shrink: 0;">
                            <img src="${event.image}" style="width: 60px; height: 45px; object-fit: cover; border-radius: 4px; border: 1px solid var(--border-color);" alt="Event">
                        </div>
                        ` : ''}
                        <div style="flex: 1; min-width: 0;">
                            <h4 style="font-size: 14px; font-weight: 600; margin: 0 0 5px 0; color: var(--text-light);">
                                ${event.title}
                                ${event.detailsLink ? '<span style="color: var(--primary-color); font-size: 12px; margin-left: 5px;">🔗</span>' : ''}
                            </h4>
                            <p style="font-size: 12px; color: var(--text-muted); margin: 0 0 3px 0;">📅 ${formatEventDate(event.date).month} ${formatEventDate(event.date).day}${event.startTime ? ` • ${formatEventTime(event.startTime, event.endTime)}` : ''}</p>
                            ${event.location ? `<p style="font-size: 12px; color: var(--text-muted); margin: 0;">📍 ${event.location}</p>` : ''}
                            ${event.description ? `<p style="font-size: 11px; color: var(--text-muted); margin: 5px 0 0 0; font-style: italic;">${event.description.length > 60 ? event.description.substring(0, 60) + '...' : event.description}</p>` : ''}
                            ${event.detailsLink ? `<p style="font-size: 11px; color: var(--primary-color); margin: 3px 0 0 0;">🔗 Details link available</p>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function deleteEvent(eventId) {
            if (confirm('Are you sure you want to delete this event?')) {
                newsletterData.customEvents = newsletterData.customEvents.filter(event => event.id !== eventId);
                updateEventsList();
                updatePreview();
                showToast('✅ Event deleted successfully', 'success');
            }
        }

        function addCustomPropertyType(name, icon = '🏘️') {
            const newPropertyType = {
                id: Date.now().toString(),
                name: name,
                icon: icon || '🏘️',
                stats: {
                    price: '',
                    priceChange: '',
                    sales: '',
                    salesChange: '',
                    listings: '',
                    listingsChange: '',
                    supply: ''
                }
            };
            
            newsletterData.customPropertyTypes.push(newPropertyType);
            renderCustomPropertyTypes();
            updatePreview();
            showToast('✅ Custom property type added!', 'success');
        }

        function renderCustomPropertyTypes() {
            const container = document.getElementById('customPropertyTypesContainer');
            
            if (!newsletterData.customPropertyTypes || newsletterData.customPropertyTypes.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = newsletterData.customPropertyTypes.map(propertyType => `
                <div style="margin-bottom: 25px;">
                    <div class="stats-section-header" style="display: flex; align-items: center; justify-content: space-between;">
                        <span>${propertyType.icon} ${propertyType.name}</span>
                        <button onclick="deleteCustomPropertyType('${propertyType.id}')" style="background: var(--danger-color); color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer;">Delete</button>
                    </div>
                    <div class="stat-item" style="margin-bottom: 8px;">
                        <label class="stat-item__label">Price</label>
                        <input type="text" class="stat-item__input" value="${propertyType.stats.price}" oninput="updateCustomPropertyTypeStat('${propertyType.id}', 'price', this.value)">
                    </div>
                    <div class="stat-item" style="margin-bottom: 8px;">
                        <label class="stat-item__label">Price Change Y/Y</label>
                        <input type="text" class="stat-item__input" value="${propertyType.stats.priceChange}" oninput="updateCustomPropertyTypeStat('${propertyType.id}', 'priceChange', this.value)">
                    </div>
                    <div class="stat-item" style="margin-bottom: 8px;">
                        <label class="stat-item__label">Sales</label>
                        <input type="text" class="stat-item__input" value="${propertyType.stats.sales}" oninput="updateCustomPropertyTypeStat('${propertyType.id}', 'sales', this.value)">
                    </div>
                    <div class="stat-item" style="margin-bottom: 8px;">
                        <label class="stat-item__label">Sales Change Y/Y</label>
                        <input type="text" class="stat-item__input" value="${propertyType.stats.salesChange}" oninput="updateCustomPropertyTypeStat('${propertyType.id}', 'salesChange', this.value)">
                    </div>
                    <div class="stat-item" style="margin-bottom: 8px;">
                        <label class="stat-item__label">New Listings</label>
                        <input type="text" class="stat-item__input" value="${propertyType.stats.listings}" oninput="updateCustomPropertyTypeStat('${propertyType.id}', 'listings', this.value)">
                    </div>
                    <div class="stat-item" style="margin-bottom: 8px;">
                        <label class="stat-item__label">Listings Change Y/Y</label>
                        <input type="text" class="stat-item__input" value="${propertyType.stats.listingsChange}" oninput="updateCustomPropertyTypeStat('${propertyType.id}', 'listingsChange', this.value)">
                    </div>
                    <div class="stat-item" style="margin-bottom: 8px;">
                        <label class="stat-item__label">Months Supply</label>
                        <input type="text" class="stat-item__input" value="${propertyType.stats.supply}" oninput="updateCustomPropertyTypeStat('${propertyType.id}', 'supply', this.value)">
                    </div>
                </div>
            `).join('');
        }

        function updateCustomPropertyTypeStat(propertyTypeId, statKey, value) {
            const propertyType = newsletterData.customPropertyTypes.find(pt => pt.id === propertyTypeId);
            if (propertyType) {
                propertyType.stats[statKey] = value;
                updatePreview();
            }
        }

        function deleteCustomPropertyType(propertyTypeId) {
            if (confirm('Are you sure you want to delete this custom property type?')) {
                newsletterData.customPropertyTypes = newsletterData.customPropertyTypes.filter(pt => pt.id !== propertyTypeId);
                renderCustomPropertyTypes();
                updatePreview();
                showToast('✅ Custom property type deleted', 'success');
            }
        }

        function toggleCustomPropertyEmojiPicker() {
            const picker = document.getElementById('customPropertyEmojiPicker');
            const isVisible = picker.style.display !== 'none';
            picker.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                document.getElementById('customPropertyTypeIcon').focus();
            }
        }

        function insertCustomPropertyEmoji(emoji) {
            const input = document.getElementById('customPropertyTypeIcon');
            input.value = emoji;
            input.focus();
            
            document.getElementById('customPropertyEmojiPicker').style.display = 'none';
            
            showToast(`Selected ${emoji} for property type`, 'success', 1500);
        }

        function toggleInstructionsPopup() {
            const popup = document.getElementById('instructionsPopup');
            const isVisible = popup.style.display !== 'none';
            popup.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                popup.style.animation = 'fadeInUp 0.3s ease forwards';
            }
        }

        function openRLPInstructions() {
            document.getElementById('instructionsPopup').style.display = 'none';
            modalManager.show('rlpInstructionsModal');
        }

        function updatePreviewStatus() {
            const statusEl = document.getElementById('previewStatus');
            const hasName = newsletterData.agent.name.trim();
            const hasMessage = newsletterData.content.personalMessage.trim();
            const hasStats = newsletterData.stats.avgPrice || newsletterData.stats.homesSold;
            
            if (hasName && hasMessage && hasStats) {
                statusEl.textContent = '✅ Your newsletter is ready! Use Export Options below to share it.';
                statusEl.style.color = 'var(--success-color)';
            } else if (hasMessage || hasName) {
                statusEl.textContent = 'Instructions to build a custom Newsletter';
                statusEl.style.color = 'var(--primary-color)';
            } else {
                statusEl.textContent = '📝 Start filling out the form to see your newsletter preview';
                statusEl.style.color = 'var(--text-muted)';
            }
        }

        function quickPrint() {
            window.scrollTo(0, 0);
            showToast('🖨️ Opening print dialog...', 'info', 2000);
            setTimeout(() => {
                window.print();
            }, 100);
        }

        function generateNewsletter() {
            updatePreview();
            showToast('✨ Newsletter generated successfully!', 'success');
        }

        function getFullHTML() {
            const newsletterHtml = document.getElementById('newsletterPreview').innerHTML;
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Newsletter - ${newsletterData.content.newsletterSeason.charAt(0).toUpperCase() + newsletterData.content.newsletterSeason.slice(1)} 2025</title>
</head>
<body style="margin: 0; padding: 20px; background: #f5f5f5; font-family: Arial, sans-serif;">
    ${newsletterHtml}
</body>
</html>`;
        }

        const exportManager = {
            copyEmailSafeHTML: () => {
                const html = getEmailSafeHTML();
                navigator.clipboard.writeText(html).then(() => {
                    modalManager.close('exportModal');
                    showToast('✅ Newsletter copied for email!', 'success', 6000);
                }).catch(() => {
                    showToast('❌ Failed to copy to clipboard', 'error');
                });
            },
            
            exportAsHTML: () => {
                const html = getEmailSafeHTML();
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `newsletter-${newsletterData.content.newsletterSeason}-2025-email-safe.html`;
                a.click();
                URL.revokeObjectURL(url);
                modalManager.close('exportModal');
                showToast('✅ Newsletter exported with email-safe tables!', 'success');
            },

            printNewsletter: () => {
                modalManager.close('exportModal');
                setTimeout(() => {
                    window.scrollTo(0, 0);
                    showToast('🖨️ Opening print dialog...', 'info', 2000);
                    window.print();
                }, 300);
            }
        };

        function getEmailSafeHTML() {
            const season = newsletterData.content.newsletterSeason;
            const config = SEASONS[season];
            const colors = newsletterData.design.colors;
            const buttonColors = newsletterData.design.buttonColors;
            const propertyColors = newsletterData.design.propertyTypeColors;
            
            // Get enabled buttons
            const enabledButtons = [];
            const buttons = newsletterData.agent.smartButtons;
            
            if (buttons.buyersGuide.url) {
                enabledButtons.push({
                    name: buttons.buyersGuide.name || 'Button 1',
                    url: buttons.buyersGuide.url,
                    color: buttonColors.buyersGuide
                });
            }
            if (buttons.sellersGuide.url) {
                enabledButtons.push({
                    name: buttons.sellersGuide.name || 'Button 2',
                    url: buttons.sellersGuide.url,
                    color: buttonColors.sellersGuide
                });
            }
            if (buttons.website.url) {
                enabledButtons.push({
                    name: buttons.website.name || 'Button 3',
                    url: buttons.website.url,
                    color: buttonColors.website
                });
            }
            if (buttons.blog.url) {
                enabledButtons.push({
                    name: buttons.blog.name || 'Button 4',
                    url: buttons.blog.url,
                    color: buttonColors.blog
                });
            }
            
            // Generate button rows (2 buttons per row max for email)
            let buttonsHtml = '';
            if (enabledButtons.length > 0) {
                buttonsHtml = '<table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="margin: 30px 0;">';
                for (let i = 0; i < enabledButtons.length; i += 2) {
                    const btn1 = enabledButtons[i];
                    const btn2 = enabledButtons[i + 1];
                    
                    buttonsHtml += '<tr>';
                    if (btn1) {
                        buttonsHtml += `
                            <td align="center" style="padding: 5px;">
                                <a href="${btn1.url}" style="display: block; background-color: ${btn1.color}; color: #ffffff; padding: 12px 20px; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 13px; text-align: center; text-transform: uppercase; letter-spacing: 0.5px;">${btn1.name}</a>
                            </td>
                        `;
                    }
                    if (btn2) {
                        buttonsHtml += `
                            <td align="center" style="padding: 5px;">
                                <a href="${btn2.url}" style="display: block; background-color: ${btn2.color}; color: #ffffff; padding: 12px 20px; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 13px; text-align: center; text-transform: uppercase; letter-spacing: 0.5px;">${btn2.name}</a>
                            </td>
                        `;
                    } else if (btn1) {
                        buttonsHtml += '<td></td>'; // Empty cell for alignment
                    }
                    buttonsHtml += '</tr>';
                }
                buttonsHtml += '</table>';
            }
            
            // Generate maintenance tips HTML
            const tipsHtml = getMaintenanceTips(config).map(tip => 
                `<tr><td style="padding: 10px 0; border-bottom: 1px solid #e0e0e0; font-size: 14px; color: ${colors.bodyText};">${tip}</td></tr>`
            ).join('');
            
            // Generate events HTML
            let eventsHtml = '';
            if (newsletterData.customEvents && newsletterData.customEvents.length > 0) {
                const sortedEvents = newsletterData.customEvents.sort((a, b) => new Date(a.date) - new Date(b.date));
                eventsHtml = sortedEvents.map(event => {
                    const eventDate = formatEventDate(event.date);
                    return `
                        <tr>
                            <td style="padding: 20px; border: 1px solid #f0f0f0; border-radius: 8px;">
                                <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                                    <tr>
                                        <td width="100" valign="top" align="center" style="padding-right: 20px;">
                                            <div style="background-color: ${colors.accent}; color: white; padding: 8px; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; border-radius: 4px;">${eventDate.month}</div>
                                            <div style="font-size: 24px; font-weight: 300; color: ${colors.headerText};">${eventDate.day}</div>
                                            ${event.startTime ? `<div style="font-size: 10px; color: ${colors.bodyText}; margin-top: 5px;">${formatEventTime(event.startTime, event.endTime)}</div>` : ''}
                                        </td>
                                        <td valign="top">
                                            <h3 style="font-size: 16px; font-weight: 500; margin: 0 0 5px 0; color: ${colors.headerText};">${event.title}</h3>
                                            ${event.location ? `<p style="font-size: 13px; color: ${colors.bodyText}; margin: 5px 0;">📍 ${event.location}</p>` : ''}
                                            ${event.description ? `<p style="font-size: 12px; color: #999; margin: 5px 0; font-style: italic;">${event.description}</p>` : ''}
                                            ${event.detailsLink ? `
                                                <div style="margin-top: 10px;">
                                                    <a href="${event.detailsLink}" style="background-color: ${colors.accent}; color: white; padding: 8px 16px; text-decoration: none; border-radius: 5px; font-size: 12px; font-weight: 600; text-transform: uppercase; display: inline-block;">Event Details</a>
                                                </div>
                                            ` : ''}
                                        </td>
                                        ${event.image ? `
                                            <td width="150" valign="top" align="center" style="padding-left: 20px;">
                                                <img src="${event.image}" width="140" style="width: 140px; height: 100px; object-fit: cover; border-radius: 6px; border: 2px solid #e0e0e0; display: block;" alt="Event">
                                            </td>
                                        ` : ''}
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr><td height="20"></td></tr>
                    `;
                }).join('');
            }
            
            // Get month name
            const currentMonth = newsletterData.content.newsletterSeason || 'august';
            const monthNames = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
            const currentIndex = monthNames.indexOf(currentMonth);
            const previousIndex = currentIndex === 0 ? 11 : currentIndex - 1;
            const previousMonth = monthNames[previousIndex].charAt(0).toUpperCase() + monthNames[previousIndex].slice(1);
            
            // Generate property type sections
            const activePropertyTypes = newsletterData.design.defaultPropertyTypes.filter(pt => !pt.deleted);
            let propertyTypeSectionsHtml = '';
            
            activePropertyTypes.forEach(propertyType => {
                const ptStats = newsletterData.stats;
                const colorKey = propertyType.colorKey || propertyType.id;
                const color = propertyColors[colorKey] || propertyColors.detached;
                
                propertyTypeSectionsHtml += `
                    <tr>
                        <td style="padding-bottom: 25px;">
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                                <tr>
                                    <td colspan="4" style="background-color: ${color}; color: white; padding: 12px 20px; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                                        ${propertyType.icon} ${propertyType.name}
                                    </td>
                                </tr>
                                <tr>
                                    <td width="25%" align="center" style="padding: 15px; border-right: 1px solid #e0e0e0; background-color: white;">
                                        <div style="font-size: 18px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 3px;">${ptStats[propertyType.id + 'Price'] || 'N/A'}</div>
                                        <div style="font-size: 10px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 3px;">Price</div>
                                        <div style="font-size: 12px; font-weight: 500; color: ${ptStats[propertyType.id + 'Change'] && ptStats[propertyType.id + 'Change'].startsWith('-') ? '#dc3545' : '#27ae60'};">${ptStats[propertyType.id + 'Change'] || 'N/A'} Y/Y</div>
                                    </td>
                                    <td width="25%" align="center" style="padding: 15px; border-right: 1px solid #e0e0e0; background-color: white;">
                                        <div style="font-size: 18px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 3px;">${ptStats[propertyType.id + 'Sales'] || 'N/A'}</div>
                                        <div style="font-size: 10px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 3px;">Sales</div>
                                        <div style="font-size: 12px; font-weight: 500; color: ${ptStats[propertyType.id + 'SalesChange'] && ptStats[propertyType.id + 'SalesChange'].startsWith('-') ? '#dc3545' : '#27ae60'};">${ptStats[propertyType.id + 'SalesChange'] || 'N/A'} Y/Y</div>
                                    </td>
                                    <td width="25%" align="center" style="padding: 15px; border-right: 1px solid #e0e0e0; background-color: white;">
                                        <div style="font-size: 18px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 3px;">${ptStats[propertyType.id + 'Listings'] || 'N/A'}</div>
                                        <div style="font-size: 10px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 3px;">Listings</div>
                                        <div style="font-size: 12px; font-weight: 500; color: ${ptStats[propertyType.id + 'ListingsChange'] && ptStats[propertyType.id + 'ListingsChange'].startsWith('-') ? '#dc3545' : '#27ae60'};">${ptStats[propertyType.id + 'ListingsChange'] || 'N/A'} Y/Y</div>
                                    </td>
                                    <td width="25%" align="center" style="padding: 15px; background-color: white;">
                                        <div style="font-size: 18px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 3px;">${ptStats[propertyType.id + 'Supply'] || 'N/A'}</div>
                                        <div style="font-size: 10px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 3px;">Months Supply</div>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                `;
            });
            
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Newsletter - ${season.charAt(0).toUpperCase() + season.slice(1)} 2025</title>
</head>
<body style="margin: 0; padding: 0; background-color: #f5f5f5; font-family: Arial, sans-serif;">
    <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="background-color: #f5f5f5;">
        <tr>
            <td align="center" style="padding: 20px;">
                <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="650" style="max-width: 650px; background-color: white;">
                    
                    <!-- Banner -->
                    <tr>
                        <td align="center" style="padding: 40px 20px;">
                            ${generateEmailBannerHtml()}
                        </td>
                    </tr>
                    
                    <!-- Subtitle -->
                    <tr>
                        <td align="center" style="padding: 20px;">
                            <h2 style="font-family: Georgia, serif; font-size: 28px; font-weight: 300; color: ${colors.headerText}; margin: 0;">${newsletterData.content.customSubtitle || config.subtitle}</h2>
                        </td>
                    </tr>
                    
                    <!-- Personal Message -->
                    <tr>
                        <td style="padding: 0 40px;">
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="background-color: ${colors.background}; border-left: 4px solid ${colors.accent}; border-radius: 8px;">
                                <tr>
                                    <td style="padding: 25px;">
                                        <p style="font-size: 16px; line-height: 1.8; color: ${colors.bodyText}; margin: 0; font-weight: 400; font-style: italic; text-align: center;">${newsletterData.content.personalMessage}</p>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                    <!-- Smart Buttons -->
                    ${enabledButtons.length > 0 ? `
                    <tr>
                        <td style="padding: 0 40px;">
                            ${buttonsHtml}
                        </td>
                    </tr>
                    ` : ''}
                    
                    <!-- Divider -->
                    <tr>
                        <td style="padding: 0 40px;">
                            <div style="height: 1px; background-color: #e0e0e0; margin: 30px 0;"></div>
                        </td>
                    </tr>
                    
                    <!-- Market Statistics Header -->
                    <tr>
                        <td align="center" style="padding: 20px 40px;">
                            <h2 style="font-family: Georgia, serif; font-size: 24px; font-weight: 400; color: ${colors.headerText}; margin: 0;">Snapshot of ${previousMonth} STATISTICS</h2>
                        </td>
                    </tr>
                    
                    <!-- Main Stats -->
                    <tr>
                        <td style="padding: 0 40px;">
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                                <tr>
                                    <td width="33%" align="center" style="padding: 20px 10px; background-color: ${colors.background}; border-radius: 8px;">
                                        <div style="font-size: 24px; font-weight: 600; color: ${colors.accent}; margin-bottom: 5px;">${newsletterData.stats.avgPrice}</div>
                                        <div style="font-size: 12px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 5px;">Total Residential Price</div>
                                        <div style="font-size: 14px; font-weight: 500; color: ${newsletterData.stats.priceChange && newsletterData.stats.priceChange.startsWith('-') ? '#dc3545' : '#27ae60'};">${newsletterData.stats.priceChange} Y/Y</div>
                                    </td>
                                    <td width="10"></td>
                                    <td width="33%" align="center" style="padding: 20px 10px; background-color: ${colors.background}; border-radius: 8px;">
                                        <div style="font-size: 24px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 5px;">${newsletterData.stats.homesSold}</div>
                                        <div style="font-size: 12px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 5px;">Sales</div>
                                        <div style="font-size: 14px; font-weight: 500; color: ${newsletterData.stats.salesChange && newsletterData.stats.salesChange.startsWith('-') ? '#dc3545' : '#27ae60'};">${newsletterData.stats.salesChange || 'N/A'} Y/Y</div>
                                    </td>
                                    <td width="10"></td>
                                    <td width="33%" align="center" style="padding: 20px 10px; background-color: ${colors.background}; border-radius: 8px;">
                                        <div style="font-size: 24px; font-weight: 600; color: ${propertyColors.row}; margin-bottom: 5px;">${newsletterData.stats.newListings}</div>
                                        <div style="font-size: 12px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 5px;">New Listings</div>
                                        <div style="font-size: 14px; font-weight: 500; color: ${newsletterData.stats.listingsChange && newsletterData.stats.listingsChange.startsWith('-') ? '#dc3545' : '#27ae60'};">${newsletterData.stats.listingsChange || 'N/A'} Y/Y</div>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                    <tr><td height="20"></td></tr>
                    
                    <!-- Secondary Stats -->
                    <tr>
                        <td style="padding: 0 40px;">
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                                <tr>
                                    <td width="50%" align="center" style="padding: 20px; background-color: ${colors.background}; border-radius: 8px;">
                                        <div style="font-size: 24px; font-weight: 600; color: ${propertyColors.apartment}; margin-bottom: 5px;">${newsletterData.stats.inventory}</div>
                                        <div style="font-size: 12px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 5px;">Total Inventory</div>
                                        <div style="font-size: 14px; font-weight: 500; color: ${newsletterData.stats.inventoryChange && newsletterData.stats.inventoryChange.startsWith('-') ? '#dc3545' : '#27ae60'};">${newsletterData.stats.inventoryChange || 'N/A'} Y/Y</div>
                                    </td>
                                    <td width="20"></td>
                                    <td width="50%" align="center" style="padding: 20px; background-color: ${colors.background}; border-radius: 8px;">
                                        <div style="font-size: 24px; font-weight: 600; color: ${propertyColors.semi}; margin-bottom: 5px;">${newsletterData.stats.monthsOfSupply || 'N/A'}</div>
                                        <div style="font-size: 12px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 5px;">Months of Supply</div>
                                        <div style="font-size: 14px; font-weight: 500; color: ${newsletterData.stats.supplyChange && newsletterData.stats.supplyChange.startsWith('-') ? '#dc3545' : '#27ae60'};">${newsletterData.stats.supplyChange || 'Balanced'}</div>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                    <tr><td height="30"></td></tr>
                    
                    <!-- Property Type Breakdown Header -->
                    ${activePropertyTypes.length > 0 ? `
                    <tr>
                        <td align="center" style="padding: 10px 40px;">
                            <h3 style="font-family: Georgia, serif; font-size: 20px; font-weight: 400; color: ${colors.headerText}; margin: 0;">Property Type Breakdown</h3>
                        </td>
                    </tr>
                    <tr><td height="20"></td></tr>
                    ` : ''}
                    
                    <!-- Property Type Sections -->
                    ${propertyTypeSectionsHtml}
                    
                    <!-- Events Section -->
                    ${eventsHtml ? `
                    <tr>
                        <td style="padding: 0 40px;">
                            <div style="height: 1px; background-color: #e0e0e0; margin: 30px 0;"></div>
                        </td>
                    </tr>
                    <tr>
                        <td align="center" style="padding: 20px 40px;">
                            <h2 style="font-family: Georgia, serif; font-size: 24px; font-weight: 400; color: ${colors.headerText}; margin: 0;">Community CALENDAR</h2>
                        </td>
                    </tr>
                    <tr><td height="20"></td></tr>
                    <tr>
                        <td style="padding: 0 40px;">
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                                ${eventsHtml}
                            </table>
                        </td>
                    </tr>
                    ` : ''}
                    
                    <!-- Maintenance Tips -->
                    <tr>
                        <td style="padding: 0 40px;">
                            <div style="height: 1px; background-color: #e0e0e0; margin: 30px 0;"></div>
                        </td>
                    </tr>
                    <tr>
                        <td align="center" style="padding: 20px 40px;">
                            <h2 style="font-family: Georgia, serif; font-size: 24px; font-weight: 400; color: ${colors.headerText}; margin: 0;">${newsletterData.content.newsletterSeason.charAt(0).toUpperCase() + newsletterData.content.newsletterSeason.slice(1)} Maintenance TIPS</h2>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 0 40px;">
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="background-color: ${colors.background}; border-radius: 8px;">
                                <tr>
                                    <td style="padding: 30px;">
                                        <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                                            ${tipsHtml}
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                    <!-- Footer / Agent Info -->
                    <tr>
                        <td align="center" style="padding: 40px; background-color: ${colors.background};">
                            ${newsletterData.images.brokerageLogo ? `
                            <div style="margin-bottom: 30px;">
                                <img src="${newsletterData.images.brokerageLogo}" width="200" style="max-width: 200px; height: auto;" alt="Brokerage Logo">
                            </div>
                            ` : ''}
                            
                            <table role="presentation" cellspacing="0" cellpadding="0" border="0" align="center">
                                <tr>
                                    <td align="center" style="padding-right: 30px;">
                                        ${newsletterData.images.agentPhoto ? 
                                            `<img src="${newsletterData.images.agentPhoto}" width="100" height="100" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; display: block;" alt="Agent Photo">` :
                                            `<div style="width: 100px; height: 100px; border-radius: 50%; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px;">Photo</div>`
                                        }
                                    </td>
                                    <td align="left">
                                        <h3 style="font-family: Georgia, serif; font-size: 22px; font-weight: 400; margin: 0 0 5px 0; color: ${colors.headerText};">${newsletterData.agent.name || 'Your Name'}</h3>
                                        <p style="font-size: 13px; color: ${colors.bodyText}; text-transform: uppercase; letter-spacing: 0.5px; margin: 0 0 10px 0;">${newsletterData.agent.company || 'Your Company'}</p>
                                        <p style="font-size: 14px; margin: 5px 0; color: ${colors.bodyText};">📱 ${newsletterData.agent.phone || '(000) 000-0000'}</p>
                                        <p style="font-size: 14px; margin: 5px 0; color: ${colors.bodyText};">✉️ ${newsletterData.agent.email || 'your@email.com'}</p>
                                        <p style="font-size: 14px; margin: 10px 0 0 0;">
                                            <a href="http://${newsletterData.agent.website || 'www.yourwebsite.com'}" style="color: ${colors.accent}; text-decoration: none;">${newsletterData.agent.website || 'www.yourwebsite.com'}</a>
                                        </p>
                                    </td>
                                    ${newsletterData.images.agentLogo ? `
                                    <td align="center" style="padding-left: 30px;">
                                        <img src="${newsletterData.images.agentLogo}" width="120" style="max-width: 120px; height: auto;" alt="Agent Logo">
                                    </td>
                                    ` : ''}
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                </table>
            </td>
        </tr>
    </table>
</body>
</html>`;
        }
        
        function generateEmailBannerHtml() {
            const bannerStyle = newsletterData.design.bannerStyle;
            const colors = newsletterData.design.colors;
            const config = SEASONS[newsletterData.content.newsletterSeason];
            
            // For email, use simpler banner without complex positioning
            if (bannerStyle === 'custom' && newsletterData.images.customBanner) {
                return `
                    <div style="width: 100%; max-width: 600px;">
                        <img src="${newsletterData.images.customBanner}" width="600" style="width: 100%; max-width: 600px; height: auto; border-radius: 12px; display: block;" alt="Newsletter Banner">
                        ${!newsletterData.design.hideCustomBannerText ? `
                        <h1 style="font-family: Georgia, serif; font-size: 32px; font-weight: 400; letter-spacing: 3px; margin: 20px 0 0 0; color: ${colors.headerText}; text-align: center;">${config.title}</h1>
                        ` : ''}
                    </div>
                `;
            } else if (bannerStyle === 'mountains') {
                return `
                    <div style="width: 100%; max-width: 600px;">
                        <img src="https://i.imgur.com/0dARtuj.png" width="600" style="width: 100%; max-width: 600px; height: auto; border-radius: 12px; display: block;" alt="Mountains Banner">
                        <h1 style="font-family: Georgia, serif; font-size: 32px; font-weight: 400; letter-spacing: 3px; margin: 20px 0 0 0; color: ${colors.headerText}; text-align: center;">${config.title}</h1>
                    </div>
                `;
            } else if (bannerStyle === 'cityscape') {
                return `
                    <div style="width: 100%; max-width: 600px;">
                        <img src="https://i.imgur.com/qok5dLZ.jpg" width="600" style="width: 100%; max-width: 600px; height: auto; border-radius: 12px; display: block;" alt="Cityscape Banner">
                        <h1 style="font-family: Georgia, serif; font-size: 32px; font-weight: 400; letter-spacing: 3px; margin: 20px 0 0 0; color: ${colors.headerText}; text-align: center;">${config.title}</h1>
                    </div>
                `;
            } else if (bannerStyle === 'blueprint') {
                return `
                    <div style="width: 100%; max-width: 600px;">
                        <img src="https://i.imgur.com/W24OelN.jpg" width="600" style="width: 100%; max-width: 600px; height: auto; border-radius: 12px; display: block;" alt="Blueprint Banner">
                        <h1 style="font-family: Georgia, serif; font-size: 32px; font-weight: 400; letter-spacing: 3px; margin: 20px 0 0 0; color: ${colors.headerText}; text-align: center;">${config.title}</h1>
                    </div>
                `;
            } else if (bannerStyle === 'minimal') {
                return `
                    <div style="border-bottom: 2px solid ${colors.accent}; padding-bottom: 10px; margin-bottom: 20px;">
                        <h1 style="font-family: Georgia, serif; font-size: 32px; font-weight: 300; letter-spacing: 3px; margin: 0; color: ${colors.headerText}; text-align: center;">${config.title}</h1>
                    </div>
                `;
            } else if (bannerStyle === 'none') {
                return `
                    <h1 style="font-family: Georgia, serif; font-size: 32px; font-weight: 400; letter-spacing: 3px; margin: 0; color: ${colors.headerText}; text-align: center;">${config.title}</h1>
                `;
            } else {
                return `
                    <h1 style="font-family: Georgia, serif; font-size: 32px; font-weight: 400; letter-spacing: 3px; margin: 0; color: ${colors.headerText}; text-align: center;">${config.title}</h1>
                `;
            }
        }

        function updatePreview() {
            const season = newsletterData.content.newsletterSeason;
            const config = SEASONS[season];
            const colors = newsletterData.design.colors;
            const buttonColors = newsletterData.design.buttonColors;
            
            const enabledButtons = [];
            const buttons = newsletterData.agent.smartButtons;
            
            if (buttons.buyersGuide.url) {
                enabledButtons.push({
                    name: buttons.buyersGuide.name || 'Button 1',
                    url: buttons.buyersGuide.url,
                    color: buttonColors.buyersGuide,
                    icon: '🔘'
                });
            }
            
            if (buttons.sellersGuide.url) {
                enabledButtons.push({
                    name: buttons.sellersGuide.name || 'Button 2',
                    url: buttons.sellersGuide.url,
                    color: buttonColors.sellersGuide,
                    icon: '🔘'
                });
            }
            
            if (buttons.website.url) {
                enabledButtons.push({
                    name: buttons.website.name || 'Button 3',
                    url: buttons.website.url,
                    color: buttonColors.website,
                    icon: '🔘'
                });
            }
            
            if (buttons.blog.url) {
                enabledButtons.push({
                    name: buttons.blog.name || 'Button 4',
                    url: buttons.blog.url,
                    color: buttonColors.blog,
                    icon: '🔘'
                });
            }
            
            let buttonsHtml = '';
            if (enabledButtons.length > 0) {
                let gridCols = '1fr';
                if (enabledButtons.length === 2) {
                    gridCols = '1fr 1fr';
                } else if (enabledButtons.length === 3) {
                    gridCols = '1fr 1fr 1fr';
                } else if (enabledButtons.length >= 4) {
                    gridCols = '1fr 1fr';
                }
                
                const smartButtonRows = [];
                for (let i = 0; i < enabledButtons.length; i += (enabledButtons.length > 4 ? 2 : enabledButtons.length)) {
                    smartButtonRows.push(enabledButtons.slice(i, i + (enabledButtons.length > 4 ? 2 : enabledButtons.length)));
                }
                
                buttonsHtml = `
                    <div style="max-width: 600px; margin: 40px auto 0; padding: 0 20px;">
                        ${smartButtonRows.map(row => `
                            <div style="display: grid; grid-template-columns: ${row.length === 1 ? '1fr' : '1fr 1fr'}; gap: 15px; margin-bottom: 15px;">
                                ${row.map(button => `
                                    <a href="${button.url}" style="display: block; background: ${button.color}; color: white; padding: 12px 16px; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 13px; text-align: center; text-transform: uppercase; letter-spacing: 0.5px;" target="_blank">
                                        ${button.icon} ${button.name}
                                    </a>
                                `).join('')}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            const template = `
                <div style="max-width: 650px; margin: 0 auto; background: white; font-family: ${newsletterData.design.bodyFont}; color: ${colors.bodyText};">
                    <div style="text-align: center; padding: 40px 20px 30px;">
                        ${generateBannerHtml()}
                        
                        <div style="text-align: center; margin: 30px 0;">
                            <div style="font-family: ${newsletterData.design.headerFont}; font-size: 28px; font-weight: 300; color: ${colors.headerText};">${newsletterData.content.customSubtitle || config.subtitle}</div>
                        </div>
                        
                        <div style="max-width: 500px; margin: 40px auto 30px auto; text-align: center; padding: 25px; background: ${colors.background}; border-left: 4px solid ${colors.accent}; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <p style="font-size: 16px; line-height: 1.8; color: ${colors.bodyText}; margin: 0; font-weight: 400; font-style: italic;">${newsletterData.content.personalMessage}</p>
                        </div>
                        
                        ${buttonsHtml}
                    </div>
                    
                    <div style="height: 1px; background: #e0e0e0; margin: 0 40px;"></div>
                    ${generateMarketStatsHtml()}
                    
                    ${newsletterData.customEvents && newsletterData.customEvents.length > 0 ? `
                    <div style="height: 1px; background: #e0e0e0; margin: 0 40px;"></div>
                    <div style="padding: 40px;">
                        <h2 style="font-family: ${newsletterData.design.headerFont}; font-size: 24px; font-weight: 400; text-align: center; margin-bottom: 30px; color: ${colors.headerText};">Community CALENDAR</h2>
                        <div style="display: grid; gap: 20px;">
                            ${newsletterData.customEvents
                                .sort((a, b) => new Date(a.date) - new Date(b.date))
                                .map(event => `
                                <div style="display: grid; grid-template-columns: 100px 1fr ${event.image ? '150px' : ''}; gap: 20px; align-items: center; padding: 20px; border: 1px solid #f0f0f0; border-radius: 8px; background: #fafafa;">
                                    <div style="text-align: center;">
                                        <div style="background: ${colors.accent}; color: white; padding: 8px; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; border-radius: 4px;">${formatEventDate(event.date).month}</div>
                                        <div style="font-size: 24px; font-weight: 300; color: ${colors.headerText};">${formatEventDate(event.date).day}</div>
                                        ${event.startTime ? `<div style="font-size: 10px; color: ${colors.bodyText}; margin-top: 5px; line-height: 1.2;">${formatEventTime(event.startTime, event.endTime)}</div>` : ''}
                                    </div>
                                    <div>
                                        <h3 style="font-size: 16px; font-weight: 500; margin-bottom: 5px; color: ${colors.headerText};">${event.title}</h3>
                                        ${event.startTime ? `<p style="font-size: 13px; color: ${colors.bodyText}; margin: 0 0 5px 0;">🕐 ${formatEventTime(event.startTime, event.endTime)}</p>` : ''}
                                        ${event.location ? `<p style="font-size: 13px; color: ${colors.bodyText}; margin: 0 0 5px 0;">📍 ${event.location}</p>` : ''}
                                        ${event.description ? `<p style="font-size: 12px; color: #999; margin: 5px 0 0 0; font-style: italic; line-height: 1.4;">${event.description}</p>` : ''}
                                        ${event.detailsLink ? `
                                        <div style="margin-top: 15px;">
                                            <a href="${event.detailsLink}" style="display: inline-block; background: ${colors.accent}; color: white; padding: 8px 16px; text-decoration: none; border-radius: 5px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;" target="_blank">
                                                📋 Event Details
                                            </a>
                                        </div>
                                        ` : ''}
                                    </div>
                                    ${event.image ? `
                                    <div style="text-align: center;">
                                        <img src="${event.image}" style="width: 140px; height: 100px; object-fit: cover; border-radius: 6px; border: 2px solid #e0e0e0;" alt="Event Image">
                                    </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="height: 1px; background: #e0e0e0; margin: 0 40px;"></div>
                    <div style="padding: 40px;">
                        <h2 style="font-family: ${newsletterData.design.headerFont}; font-size: 24px; font-weight: 400; text-align: center; margin-bottom: 30px; color: ${colors.headerText};">${newsletterData.content.newsletterSeason.charAt(0).toUpperCase() + newsletterData.content.newsletterSeason.slice(1)} Maintenance TIPS</h2>
                        <div style="background: ${colors.background}; padding: 30px; border-radius: 8px;">
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                ${getMaintenanceTips(config).map(tip => `
                                    <li style="padding: 10px 0; border-bottom: 1px solid #e0e0e0; font-size: 14px; color: ${colors.bodyText};">${tip}</li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    <div style="background: ${colors.background}; padding: 40px; text-align: center;">
                        ${newsletterData.images.brokerageLogo ? `
                        <div style="margin-bottom: 30px;">
                            <img src="${newsletterData.images.brokerageLogo}" style="max-width: 200px; max-height: 80px; object-fit: contain;" alt="Brokerage Logo">
                        </div>
                        ` : ''}
                        
                        <div style="display: inline-flex; align-items: center; gap: 30px;">
                            <div style="width: 100px; height: 100px; border-radius: 50%; overflow: hidden; background: #e0e0e0;">
                                ${newsletterData.images.agentPhoto ? 
                                    `<img src="${newsletterData.images.agentPhoto}" style="width: 100%; height: 100%; object-fit: cover;" alt="Agent Photo">` :
                                    `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px;">Agent Photo</div>`
                                }
                            </div>
                            <div style="text-align: left;">
                                <h3 style="font-family: ${newsletterData.design.headerFont}; font-size: 22px; font-weight: 400; margin-bottom: 5px; color: ${colors.headerText};">${newsletterData.agent.name || 'Your Name'}</h3>
                                <p style="font-size: 13px; color: ${colors.bodyText}; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;">${newsletterData.agent.company || 'Your Company'}</p>
                                <p style="font-size: 14px; margin: 5px 0; color: ${colors.bodyText};">📱 ${newsletterData.agent.phone || '(000) 000-0000'}</p>
                                <p style="font-size: 14px; margin: 5px 0; color: ${colors.bodyText};">✉️ ${newsletterData.agent.email || 'your@email.com'}</p>
                            </div>
                            ${newsletterData.images.agentLogo ? `
                            <div style="margin-left: 20px;">
                                <img src="${newsletterData.images.agentLogo}" style="max-width: 120px; max-height: 80px; object-fit: contain;" alt="Agent Logo">
                            </div>
                            ` : ''}
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <a href="http://${newsletterData.agent.website || 'www.yourwebsite.com'}" style="color: ${colors.accent}; text-decoration: none; font-size: 14px;">${newsletterData.agent.website || 'www.yourwebsite.com'}</a>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('newsletterPreview').innerHTML = template;
            updatePreviewStatus();
        }

        function generateBannerHtml() {
            const bannerStyle = newsletterData.design.bannerStyle;
            const headerFont = newsletterData.design.headerFont;
            const colors = newsletterData.design.colors;
            const config = SEASONS[newsletterData.content.newsletterSeason];
            
            switch (bannerStyle) {
                case 'mountains':
                    return `
                        <div style="position: relative; margin: 40px 0 60px 0; padding: 50px 20px;">
                            <div style="position: relative; width: 600px; height: 300px; border-radius: 20px; overflow: hidden; background-image: url('https://i.imgur.com/0dARtuj.png'); background-size: cover; background-position: center; margin: 0 auto;">
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3);"></div>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 3;">
                                    <h1 style="font-family: ${headerFont}; font-size: 42px; font-weight: 400; letter-spacing: 4px; margin: 0; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.7);">${config.title}</h1>
                                </div>
                            </div>
                        </div>
                    `;

                case 'cityscape':
                    return `
                        <div style="position: relative; margin: 40px 0 60px 0; padding: 50px 20px;">
                            <div style="position: relative; width: 600px; height: 300px; border-radius: 20px; overflow: hidden; background-image: url('https://i.imgur.com/qok5dLZ.jpg'); background-size: cover; background-position: center; margin: 0 auto;">
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3);"></div>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 3;">
                                    <h1 style="font-family: ${headerFont}; font-size: 42px; font-weight: 400; letter-spacing: 4px; margin: 0; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.7);">${config.title}</h1>
                                </div>
                            </div>
                        </div>
                    `;

                case 'blueprint':
                    return `
                        <div style="position: relative; margin: 40px 0 60px 0; padding: 50px 20px;">
                            <div style="position: relative; width: 600px; height: 300px; border-radius: 20px; overflow: hidden; background-image: url('https://i.imgur.com/W24OelN.jpg'); background-size: cover; background-position: center; margin: 0 auto;">
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3);"></div>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 3;">
                                    <h1 style="font-family: ${headerFont}; font-size: 42px; font-weight: 400; letter-spacing: 4px; margin: 0; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.8);">${config.title}</h1>
                                </div>
                            </div>
                        </div>
                    `;

                case 'custom':
                    return `
                        <div style="position: relative; margin: 40px 0 60px 0; padding: 50px 20px;">
                            ${newsletterData.images.customBanner ? `
                            <div style="position: relative; width: 600px; height: 300px; border-radius: 20px; overflow: hidden; background-image: url('${newsletterData.images.customBanner}'); background-size: cover; background-position: center; margin: 0 auto;">
                                ${!newsletterData.design.hideCustomBannerText ? `
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3);"></div>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 3;">
                                    <h1 style="font-family: ${headerFont}; font-size: 42px; font-weight: 400; letter-spacing: 4px; margin: 0; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.7);">${config.title}</h1>
                                </div>
                                ` : ''}
                            </div>
                            ` : `
                            <div style="position: relative; width: 600px; height: 300px; border-radius: 20px; overflow: hidden; background: linear-gradient(135deg, ${colors.accent} 0%, ${colors.headerText} 50%, ${colors.accent} 100%); margin: 0 auto;">
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 3;">
                                    <h1 style="font-family: ${headerFont}; font-size: 42px; font-weight: 400; letter-spacing: 4px; margin: 0; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.5);">${config.title}</h1>
                                    <p style="color: white; font-size: 14px; margin-top: 10px; opacity: 0.9;">Upload custom banner image above</p>
                                </div>
                            </div>
                            `}
                        </div>
                    `;

                case 'minimal':
                    return `
                        <div style="text-align: center; margin: 40px 0; padding: 50px 20px;">
                            <div style="border-bottom: 2px solid ${colors.accent}; display: inline-block; margin-bottom: 40px; padding-bottom: 10px;">
                                <h1 style="font-family: ${headerFont}; font-size: 36px; font-weight: 300; letter-spacing: 3px; margin: 0; color: ${colors.headerText};">${config.title}</h1>
                            </div>
                        </div>
                    `;

                case 'none':
                    return `
                        <div style="text-align: center; margin: 40px 0; padding: 20px;">
                            <h1 style="font-family: ${headerFont}; font-size: 36px; font-weight: 400; letter-spacing: 3px; margin: 0; color: ${colors.headerText};">${config.title}</h1>
                        </div>
                    `;

                default:
                    return `
                        <div style="text-align: center; margin: 40px 0;">
                            <h1 style="font-family: ${headerFont}; font-size: 36px; font-weight: 400; letter-spacing: 3px; margin: 0; color: ${colors.headerText};">${config.title}</h1>
                        </div>
                    `;
            }
        }

        function generateMarketStatsHtml() {
            const stats = newsletterData.stats;
            const headerFont = newsletterData.design.headerFont;
            const colors = newsletterData.design.colors;
            const propertyColors = newsletterData.design.propertyTypeColors;
            
            const currentMonth = newsletterData.content.newsletterSeason || 'august';
            const monthNames = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
            const currentIndex = monthNames.indexOf(currentMonth);
            const previousIndex = currentIndex === 0 ? 11 : currentIndex - 1;
            const previousMonth = monthNames[previousIndex].charAt(0).toUpperCase() + monthNames[previousIndex].slice(1);
            
            const activePropertyTypes = newsletterData.design.defaultPropertyTypes.filter(pt => !pt.deleted);
            
            let propertyTypeSections = '';
            
            activePropertyTypes.forEach(propertyType => {
                const ptStats = newsletterData.stats;
                const colorKey = propertyType.colorKey || propertyType.id;
                const color = propertyColors[colorKey] || propertyColors.detached;
                
                propertyTypeSections += `
                    <div style="margin-bottom: 25px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                        <div style="background: ${color}; color: white; padding: 12px 20px; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                            ${propertyType.icon} ${propertyType.name}
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0;">
                            <div style="text-align: center; padding: 15px; border-right: 1px solid #e0e0e0; background: white;">
                                <div style="font-size: 18px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 3px;">${ptStats[propertyType.id + 'Price'] || 'N/A'}</div>
                                <div style="font-size: 10px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 3px;">Price</div>
                                <div style="font-size: 12px; font-weight: 500; color: ${ptStats[propertyType.id + 'Change'] && ptStats[propertyType.id + 'Change'].startsWith('-') ? '#dc3545' : '#27ae60'};">${ptStats[propertyType.id + 'Change'] || 'N/A'} Y/Y</div>
                            </div>
                            <div style="text-align: center; padding: 15px; border-right: 1px solid #e0e0e0; background: white;">
                                <div style="font-size: 18px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 3px;">${ptStats[propertyType.id + 'Sales'] || 'N/A'}</div>
                                <div style="font-size: 10px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 3px;">Sales</div>
                                <div style="font-size: 12px; font-weight: 500; color: ${ptStats[propertyType.id + 'SalesChange'] && ptStats[propertyType.id + 'SalesChange'].startsWith('-') ? '#dc3545' : '#27ae60'};">${ptStats[propertyType.id + 'SalesChange'] || 'N/A'} Y/Y</div>
                            </div>
                            <div style="text-align: center; padding: 15px; border-right: 1px solid #e0e0e0; background: white;">
                                <div style="font-size: 18px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 3px;">${ptStats[propertyType.id + 'Listings'] || 'N/A'}</div>
                                <div style="font-size: 10px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 3px;">Listings</div>
                                <div style="font-size: 12px; font-weight: 500; color: ${ptStats[propertyType.id + 'ListingsChange'] && ptStats[propertyType.id + 'ListingsChange'].startsWith('-') ? '#dc3545' : '#27ae60'};">${ptStats[propertyType.id + 'ListingsChange'] || 'N/A'} Y/Y</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white;">
                                <div style="font-size: 18px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 3px;">${ptStats[propertyType.id + 'Supply'] || 'N/A'}</div>
                                <div style="font-size: 10px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 3px;">Months Supply</div>
                                <div style="font-size: 12px; font-weight: 500; color: ${colors.bodyText};"></div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            return `
                <div style="padding: 40px;">
                    <h2 style="font-family: ${headerFont}; font-size: 24px; font-weight: 400; text-align: center; margin-bottom: 30px; color: ${colors.headerText};">Snapshot of ${previousMonth} STATISTICS</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                        <div style="text-align: center; padding: 20px; background: ${colors.background}; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: ${colors.accent}; margin-bottom: 5px;">${stats.avgPrice}</div>
                            <div style="font-size: 12px; color: ${colors.bodyText}; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Total Residential Price</div>
                            <div style="font-size: 14px; font-weight: 500; color: ${stats.priceChange && stats.priceChange.startsWith('-') ? '#dc3545' : '#27ae60'};">${stats.priceChange} Y/Y</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: ${colors.background}; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 5px;">${stats.homesSold}</div>
                            <div style="font-size: 12px; color: ${colors.bodyText}; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Sales</div>
                            <div style="font-size: 14px; font-weight: 500; color: ${stats.salesChange && stats.salesChange.startsWith('-') ? '#dc3545' : '#27ae60'};">${stats.salesChange || 'N/A'} Y/Y</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: ${colors.background}; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: ${propertyColors.row}; margin-bottom: 5px;">${stats.newListings}</div>
                            <div style="font-size: 12px; color: ${colors.bodyText}; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">New Listings</div>
                            <div style="font-size: 14px; font-weight: 500; color: ${stats.listingsChange && stats.listingsChange.startsWith('-') ? '#dc3545' : '#27ae60'};">${stats.listingsChange || 'N/A'} Y/Y</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 40px;">
                        <div style="text-align: center; padding: 20px; background: ${colors.background}; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: ${propertyColors.apartment}; margin-bottom: 5px;">${stats.inventory}</div>
                            <div style="font-size: 12px; color: ${colors.bodyText}; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Total Inventory</div>
                            <div style="font-size: 14px; font-weight: 500; color: ${stats.inventoryChange && stats.inventoryChange.startsWith('-') ? '#dc3545' : '#27ae60'};">${stats.inventoryChange || 'N/A'} Y/Y</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: ${colors.background}; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: ${propertyColors.semi}; margin-bottom: 5px;">${stats.monthsOfSupply || 'N/A'}</div>
                            <div style="font-size: 12px; color: ${colors.bodyText}; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Months of Supply</div>
                            <div style="font-size: 14px; font-weight: 500; color: ${stats.supplyChange && stats.supplyChange.startsWith('-') ? '#dc3545' : '#27ae60'};">${stats.supplyChange || 'Balanced'}</div>
                        </div>
                    </div>

                    ${activePropertyTypes.length > 0 ? `<h3 style="font-family: ${headerFont}; font-size: 20px; font-weight: 400; text-align: center; margin: 30px 0 25px 0; color: ${colors.headerText};">Property Type Breakdown</h3>` : ''}
                    
                    ${propertyTypeSections}

                    ${newsletterData.customPropertyTypes && newsletterData.customPropertyTypes.length > 0 ? 
                        newsletterData.customPropertyTypes.map(propertyType => `
                        <div style="margin-bottom: 25px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                            <div style="background: ${propertyColors.custom}; color: white; padding: 12px 20px; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                                ${propertyType.icon} ${propertyType.name}
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0;">
                                <div style="text-align: center; padding: 15px; border-right: 1px solid #e0e0e0; background: white;">
                                    <div style="font-size: 18px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 3px;">${propertyType.stats.price || 'N/A'}</div>
                                    <div style="font-size: 10px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 3px;">Price</div>
                                    <div style="font-size: 12px; font-weight: 500; color: ${propertyType.stats.priceChange && propertyType.stats.priceChange.startsWith('-') ? '#dc3545' : '#27ae60'};">${propertyType.stats.priceChange || 'N/A'} Y/Y</div>
                                </div>
                                <div style="text-align: center; padding: 15px; border-right: 1px solid #e0e0e0; background: white;">
                                    <div style="font-size: 18px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 3px;">${propertyType.stats.sales || 'N/A'}</div>
                                    <div style="font-size: 10px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 3px;">Sales</div>
                                    <div style="font-size: 12px; font-weight: 500; color: ${propertyType.stats.salesChange && propertyType.stats.salesChange.startsWith('-') ? '#dc3545' : '#27ae60'};">${propertyType.stats.salesChange || 'N/A'} Y/Y</div>
                                </div>
                                <div style="text-align: center; padding: 15px; border-right: 1px solid #e0e0e0; background: white;">
                                    <div style="font-size: 18px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 3px;">${propertyType.stats.listings || 'N/A'}</div>
                                    <div style="font-size: 10px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 3px;">Listings</div>
                                    <div style="font-size: 12px; font-weight: 500; color: ${propertyType.stats.listingsChange && propertyType.stats.listingsChange.startsWith('-') ? '#dc3545' : '#27ae60'};">${propertyType.stats.listingsChange || 'N/A'} Y/Y</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: white;">
                                    <div style="font-size: 18px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 3px;">${propertyType.stats.supply || 'N/A'}</div>
                                    <div style="font-size: 10px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 3px;">Months Supply</div>
                                    <div style="font-size: 12px; font-weight: 500; color: ${colors.bodyText};"></div>
                                </div>
                            </div>
                        </div>
                        `).join('') : ''
                    }
                    
                    ${newsletterData.content.marketButtonText ? `
                    <div style="text-align: center; margin-top: 30px;">
                        <a href="${newsletterData.content.marketButtonUrl || '#'}" style="display: inline-block; background: ${newsletterData.design.buttonColors.marketReport}; color: white; padding: 15px 30px; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;" target="_blank">${newsletterData.content.marketButtonText}</a>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function setupEventListeners() {
            ['agentName', 'companyName', 'agentPhone', 'agentEmail', 'agentWebsite', 'personalMessage', 'customSubtitle', 'marketButtonText', 'marketButtonUrl', 'buyersGuideName', 'buyersGuideUrl', 'sellersGuideName', 'sellersGuideUrl', 'websiteName', 'myWebsiteUrl', 'blogName', 'blogUrl'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', (e) => handleFormChange(id, e.target.value));
                }
            });

            ['headerTextColor', 'bodyTextColor', 'accentColor', 'backgroundAccent', 'buyersGuideColor', 'sellersGuideColor', 'websiteColor', 'blogColor', 'marketButtonColor', 'detachedColor', 'semiColor', 'rowColor', 'apartmentColor', 'customPropertyColor'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', (e) => handleFormChange(id, e.target.value));
                }
            });

            ['headerTextColorHex', 'bodyTextColorHex', 'accentColorHex', 'backgroundAccentHex', 'buyersGuideColorHex', 'sellersGuideColorHex', 'websiteColorHex', 'blogColorHex', 'marketButtonColorHex', 'detachedColorHex', 'semiColorHex', 'rowColorHex', 'apartmentColorHex', 'customPropertyColorHex'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    const baseId = id.replace('Hex', '');
                    element.addEventListener('input', (e) => handleColorHexChange(baseId, baseId, e.target.value));
                }
            });

            ['bannerStyle', 'headerFont', 'bodyFont', 'newsletterSeason'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', (e) => handleFormChange(id, e.target.value));
                }
            });

            ['hideCustomBannerText', 'buyersGuideEnabled', 'sellersGuideEnabled', 'websiteEnabled', 'blogEnabled'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', (e) => handleFormChange(id, e.target.checked));
                }
            });

            const addCustomPropertyTypeForm = document.getElementById('addCustomPropertyTypeForm');
            if (addCustomPropertyTypeForm) {
                addCustomPropertyTypeForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const name = document.getElementById('customPropertyTypeName').value.trim();
                    const icon = document.getElementById('customPropertyTypeIcon').value.trim();
                    
                    if (!name) {
                        showToast('❌ Please enter a property type name', 'error');
                        return;
                    }
                    
                    addCustomPropertyType(name, icon);
                    modalManager.close('addCustomPropertyTypeModal');
                });
            }
            const addEventForm = document.getElementById('addEventForm');
            if (addEventForm) {
                addEventForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const title = document.getElementById('eventTitle').value.trim();
                    const date = document.getElementById('eventDate').value;
                    const startTime = document.getElementById('eventStartTime').value;
                    const endTime = document.getElementById('eventEndTime').value;
                    const location = document.getElementById('eventLocation').value.trim();
                    const description = document.getElementById('eventDescription').value.trim();
                    const detailsLink = document.getElementById('eventDetailsLink').value.trim();
                    
                    if (!title || !date) {
                        showToast('❌ Please fill in Title and Date (required fields)', 'error');
                        return;
                    }
                    
                    if (detailsLink && !detailsLink.startsWith('http://') && !detailsLink.startsWith('https://')) {
                        showToast('❌ Event details link must start with http:// or https://', 'error');
                        return;
                    }
                    
                    if (startTime && endTime && endTime <= startTime) {
                        showToast('❌ End time must be after start time', 'error');
                        return;
                    }
                    
                    if (!newsletterData.customEvents) {
                        newsletterData.customEvents = [];
                    }
                    
                    const newEvent = {
                        id: Date.now().toString(),
                        title,
                        date,
                        startTime,
                        endTime,
                        location,
                        description,
                        detailsLink,
                        image: newsletterData.images.currentEventImage
                    };
                    
                    newsletterData.customEvents.push(newEvent);
                    
                    newsletterData.images.currentEventImage = null;
                    
                    showToast('✅ Event added successfully!', 'success');
                    modalManager.close('addEventModal');
                    updateEventsList();
                    updatePreview();
                });
            }

            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    generateNewsletter();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const openModal = document.querySelector('.modal-overlay--show');
                    if (openModal) {
                        modalManager.close(openModal.id);
                    }
                }
            });
        }

        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.animation = 'fadeInUp 0.8s ease forwards';
                }
            });
        }, observerOptions);

        document.addEventListener('DOMContentLoaded', function() {
            try {
                const currentSeason = newsletterData.content.newsletterSeason;
                const seasonConfig = SEASONS[currentSeason];
                if (seasonConfig && seasonConfig.tips) {
                    newsletterData.maintenanceTips = [...seasonConfig.tips];
                }
                
                renderStats();
                updatePropertyTypeColorInputs();
                setupEventListeners();
                updateMonthDisplay();
                updateEventsList();
                renderMaintenanceTipsSummary();
                updateColorInputs();
                updatePreview();
                updatePreviewStatus();
                
                document.querySelectorAll('.fade-in').forEach(element => {
                    observer.observe(element);
                });
                
                console.log('💡 Newsletter Builder Pro with Smart Tools Navigation:');
                console.log('• Navigation system integrated with Firebase authentication');
                console.log('• All original newsletter features preserved and enhanced');
                console.log('• Page protection and modal systems operational');
                console.log('• Responsive design maintained across all screen sizes');
                
            } catch (error) {
                console.error('Application initialization error:', error);
                showToast('⚠️ Application started with some limitations. Please refresh if you encounter issues.', 'warning', 6000);
            }
        });
    </script>
</body>
</html>
